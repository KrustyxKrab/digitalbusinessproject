---
phase: 11-product-system-integration
plan: 01
type: execute
---

<objective>
Update recommendation logic, routine system, and abo features to use JSON-based product data structure.

Purpose: Connect all product-dependent systems to new dynamic product structure.
Output: All product references throughout the app use slug-based JSON data consistently.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/phases/09-dynamic-routing-implementation/09-01-SUMMARY.md
@.planning/phases/10-products-overview-refactor/10-01-SUMMARY.md
@src/utils/context-awareness.ts
@src/stores/user-store.ts
@src/pages/dashboard.astro
@src/pages/subscription.astro

**Tech stack available:**
- Nanostores for state management
- IndexedDB for persistence
- Dynamic product loading from JSON

**Established patterns:**
- Product metadata: public/products/{slug}/product-info.json
- Product slugs: kebab-case identifiers
- Dynamic routing: /produkte/{slug}

**Constraining decisions:**
- [09-01]: All product links use /produkte/{slug} format
- [10-01]: Products loaded dynamically from JSON files
- [04-05]: Recommendations widget uses PersonalizedRecommendations component

**Context:**
Product pages and overview now use JSON data. However, some systems still reference products by hardcoded IDs or old structures:
- src/utils/context-awareness.ts: getContextualRecommendations() returns product objects
- Routine system in user-store.ts: May reference products by ID
- Dashboard displays routine products
- Subscription page manages product subscriptions

Need to ensure all these systems use slug-based references and can load full product data from JSON when needed.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update recommendation system to use product slugs</name>
  <files>src/utils/context-awareness.ts, src/components/widgets/PersonalizedRecommendations.astro</files>
  <action>
    Refactor getContextualRecommendations() in context-awareness.ts to return product slugs instead of full product objects.

    Changes to context-awareness.ts:
    1. Update return type from Product[] to string[] (array of slugs)
    2. Recommendation logic returns slug identifiers like:
       - "kariesschutz-zahnpasta"
       - "sensitive-zahnpasta"
       - "elmexjunior"
       - etc.
    3. Keep existing recommendation logic (based on user concerns, age, dental issues)
    4. Add JSDoc comment explaining slug-based approach

    Changes to PersonalizedRecommendations.astro:
    1. Receive array of recommended product slugs from context-awareness
    2. For each slug, load full product data from /products/{slug}/product-info.json
    3. Client-side loading:
       ```typescript
       async function loadProduct(slug: string): Promise<ProductDetail | null> {
         try {
           const response = await fetch(`/products/${slug}/product-info.json`);
           return await response.json();
         } catch (error) {
           console.error(`Failed to load product: ${slug}`, error);
           return null;
         }
       }
       ```
    4. Display products using loaded data
    5. Maintain existing discount code and expert images functionality

    AVOID: Hardcoding full product objects in recommendation logic. MUST use slugs + dynamic loading.

    WHY: Separates concerns - recommendation logic determines WHICH products, component loads HOW to display them. Adding new products doesn't require updating recommendation code.
  </action>
  <verify>
    npm run dev, open homepage, recommendation widget loads products dynamically from JSON via slugs
  </verify>
  <done>
    Recommendation system uses slug-based references, loads full product data dynamically
  </done>
</task>

<task type="auto">
  <name>Task 2: Update routine and abo systems to use product slugs</name>
  <files>src/stores/user-store.ts, src/pages/dashboard.astro, src/pages/subscription.astro, src/pages/routine-builder.astro</files>
  <action>
    Update routine and subscription systems to reference products by slug instead of full product objects.

    Changes to user-store.ts:
    1. Update RoutineStep interface (if needed):
       - Change product?: Product to productSlug?: string
       - Store only slug reference in IndexedDB
    2. Update UserProduct interface:
       - Change to store productSlug instead of full Product object
    3. Maintain backward compatibility if existing data uses old format

    Changes to dashboard.astro:
    1. Load full product details from JSON when displaying routine:
       ```typescript
       const routineProducts = await Promise.all(
         routine.steps
           .filter(step => step.productSlug)
           .map(async step => {
             const res = await fetch(`/products/${step.productSlug}/product-info.json`);
             return res.json();
           })
       );
       ```
    2. Display product names and images using loaded data
    3. Product links use /produkte/${productSlug}

    Changes to subscription.astro:
    1. Update subscription product list to reference by slug
    2. Load product details dynamically for display
    3. Maintain existing subscription management functionality

    Changes to routine-builder.astro:
    1. Product selection stores slug only
    2. Display uses dynamically loaded product data

    AVOID: Storing full product objects in IndexedDB. MUST store slugs only.

    WHY: Reduces storage size, prevents stale data (product details can be updated in JSON without clearing user data), maintains single source of truth.
  </action>
  <verify>
    npm run dev, test routine builder adds products by slug, dashboard loads product details dynamically, subscription page displays products correctly
  </verify>
  <done>
    Routine, abo, and dashboard systems use slug-based product references with dynamic loading
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fully integrated slug-based product system across all features</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Test Recommendations:
       - Visit homepage
       - Verify PersonalizedRecommendations widget loads products
       - Click recommended product, should navigate to correct product page
    3. Test Routine System:
       - Visit /routine-builder
       - Add products to routine (should store slug only)
       - Visit /dashboard
       - Verify routine displays correct product names and images
       - Click routine product, should navigate to product page
    4. Test Subscription:
       - Visit /subscription
       - Verify subscription products display correctly
       - Product images and names load from JSON
    5. Test Browser Storage:
       - Open DevTools → Application → IndexedDB
       - Check user data: products should be stored as slugs, not full objects
    6. Test Product Updates:
       - Edit a product-info.json (change product name)
       - Refresh page, verify change reflects everywhere (recommendations, routine, dashboard)
    7. Verify: No console errors, all images load correctly
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Recommendation system returns slugs, loads product details dynamically
- [ ] Routine system stores product slugs in IndexedDB
- [ ] Dashboard loads routine products from JSON
- [ ] Subscription system uses slug-based references
- [ ] All product links use /produkte/{slug} format
- [ ] No full product objects stored in localStorage/IndexedDB
</verification>

<success_criteria>

- All product-dependent systems integrated with JSON structure
- Product references use slugs consistently
- Dynamic loading implemented for all product displays
- Storage efficient (slugs only, not full objects)
- Human verification confirms end-to-end functionality
  </success_criteria>

<output>
After completion, create `.planning/phases/11-product-system-integration/11-01-SUMMARY.md`:

# Phase 11 Plan 1: Product System Integration Summary

**Connected all product-dependent features to slug-based JSON architecture**

## Accomplishments

- Refactored recommendation system to return product slugs
- Updated PersonalizedRecommendations to load products dynamically via fetch
- Modified user-store.ts to store product slugs instead of full objects
- Updated dashboard to load routine products from JSON
- Updated subscription and routine-builder to use slug references
- Reduced IndexedDB storage footprint by ~80% (slugs vs full objects)
- Ensured product detail updates reflect immediately across all features

## Files Created/Modified

- `src/utils/context-awareness.ts` - Returns product slugs instead of objects
- `src/components/widgets/PersonalizedRecommendations.astro` - Dynamic product loading
- `src/stores/user-store.ts` - Stores product slugs only
- `src/pages/dashboard.astro` - Dynamic routine product loading
- `src/pages/subscription.astro` - Slug-based subscription products
- `src/pages/routine-builder.astro` - Stores product slugs

## Decisions Made

- Product data separation: Recommendation logic returns WHICH products (slugs), components handle HOW to display them (load JSON)
- Storage strategy: IndexedDB stores minimal references (slugs), not full product objects
- Backward compatibility: Code handles both old format (full objects) and new format (slugs) gracefully
- Fetch strategy: Client-side fetch for dynamic product loading (server-side at build time not needed for these use cases)

## Issues Encountered

None

## Next Step

Ready for Phase 12 (Resume v1.0 Roadmap)
</output>
