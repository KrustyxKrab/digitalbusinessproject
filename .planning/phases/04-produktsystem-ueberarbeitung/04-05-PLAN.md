---
phase: 04-produktsystem-ueberarbeitung
plan: 05
subsystem: recommendations
tags: [product-recommendations, discounts, buy-links, personalization]

# Dependency graph
requires:
  - phase: 04-produktsystem-ueberarbeitung
    plan: 04-01
    provides: Product overview with real product data
  - phase: 04-produktsystem-ueberarbeitung
    plan: 04-02
    provides: Enhanced product pages with buy buttons
  - phase: 03-hauptseite-personalisierung
    plan: 03-02
    provides: PersonalizedRecommendations widget with 9 products
provides:
  - Functional product recommendations on homepage and product pages
  - Working "Wo kaufen" feature with retailer links
  - Discount badges on recommended products
  - Cross-product recommendations on product detail pages
affects: [05-dashboard-routine]

# Tech tracking
tech-stack:
  added: []
  patterns: [product-recommendations, discount-incentives, retailer-integration]

key-files:
  created: []
  modified: [src/components/widgets/PersonalizedRecommendations.astro, src/pages/produkte/*.astro, src/pages/beratung/wo-kaufen.astro]
---

<objective>
Make product recommendations fully functional with working "Wo kaufen" links, discount badges on recommended products, and cross-product recommendations on product detail pages.

Foundation: PersonalizedRecommendations widget from Phase 3 + enhanced product system from Phase 4 plans 01-04.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**PersonalizedRecommendations widget from Phase 3:**
@.planning/phases/03-hauptseite-personalisierung/03-FIX-SUMMARY.md
- Integrated 9 real products with images
- Personalization logic based on concern/ageGroup
- Expert endorsement section

**"Wo kaufen" page:**
@src/pages/beratung/wo-kaufen.astro

**Requirements from PROJECT.md:**
- Produktvorschl√§ge funktionierend machen
- "Wo kaufen" Links einf√ºgen
- Rabatt auf Empfehlungen anbieten ("Damit Sie das neue Produkt ausprobieren k√∂nnen")
- "Wo kaufen" Feature funktional machen (aktuell broken - from 03-ISSUES.md)
</context>

<tasks>

<task type="auto">
  <name>Fix "Wo kaufen" feature with functional retailer links</name>
  <files>src/pages/beratung/wo-kaufen.astro</files>
  <action>
    Repair and enhance "Wo kaufen" page with working retailer links:

    1. Read query parameter ?product={slug} from URL:
       ```javascript
       const urlParams = new URLSearchParams(window.location.search);
       const productSlug = urlParams.get('product');
       ```

    2. Display product name if provided:
       ```html
       <h1 id="page-title" class="text-4xl font-brand font-bold mb-4">
         Wo kaufen: <span id="product-name"></span>
       </h1>
       <script>
         const productSlug = new URLSearchParams(window.location.search).get('product');
         const productNameEl = document.getElementById('product-name');
         if (productSlug) {
           // Map slug to display name
           const productNames = {
             'kariesschutz-zahnpasta': 'elmex KARIESSCHUTZ Zahnpasta',
             'sensitive-zahnpasta': 'elmex SENSITIVE Zahnpasta',
             // ... more products
           };
           productNameEl.textContent = productNames[productSlug] || 'elmex Produkt';
         } else {
           document.getElementById('page-title').textContent = 'Wo kaufen';
         }
       </script>
       ```

    3. Add retailer cards with direct buy links:
       ```html
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 my-12">
         <!-- dm-drogerie markt -->
         <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
           <div class="flex items-center gap-4 mb-4">
             <div class="w-16 h-16 bg-neutral-100 rounded-lg flex items-center justify-center">
               <span class="text-2xl font-bold text-primary">dm</span>
             </div>
             <div>
               <h3 class="font-semibold text-lg">dm-drogerie markt</h3>
               <p class="text-sm text-neutral-600">Online & in √ºber 2.000 Filialen</p>
             </div>
           </div>
           <a href="https://www.dm.de/search?query=elmex" target="_blank" rel="noopener noreferrer"
              class="block w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white text-center font-semibold rounded-full transition-colors">
             Bei dm kaufen
           </a>
         </div>

         <!-- Rossmann -->
         <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
           <div class="flex items-center gap-4 mb-4">
             <div class="w-16 h-16 bg-neutral-100 rounded-lg flex items-center justify-center">
               <span class="text-2xl font-bold text-red-600">R</span>
             </div>
             <div>
               <h3 class="font-semibold text-lg">Rossmann</h3>
               <p class="text-sm text-neutral-600">Online & in √ºber 2.200 Filialen</p>
             </div>
           </div>
           <a href="https://www.rossmann.de/search?text=elmex" target="_blank" rel="noopener noreferrer"
              class="block w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white text-center font-semibold rounded-full transition-colors">
             Bei Rossmann kaufen
           </a>
         </div>

         <!-- Amazon -->
         <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
           <div class="flex items-center gap-4 mb-4">
             <div class="w-16 h-16 bg-neutral-100 rounded-lg flex items-center justify-center">
               <span class="text-2xl font-bold">üì¶</span>
             </div>
             <div>
               <h3 class="font-semibold text-lg">Amazon</h3>
               <p class="text-sm text-neutral-600">Versand in 1-2 Tagen</p>
             </div>
           </div>
           <a href="https://www.amazon.de/s?k=elmex" target="_blank" rel="noopener noreferrer"
              class="block w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white text-center font-semibold rounded-full transition-colors">
             Bei Amazon kaufen
           </a>
         </div>

         <!-- DocMorris -->
         <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
           <div class="flex items-center gap-4 mb-4">
             <div class="w-16 h-16 bg-neutral-100 rounded-lg flex items-center justify-center">
               <span class="text-2xl font-bold text-green-600">+</span>
             </div>
             <div>
               <h3 class="font-semibold text-lg">DocMorris</h3>
               <p class="text-sm text-neutral-600">Online-Apotheke</p>
             </div>
           </div>
           <a href="https://www.docmorris.de/search?searchTerm=elmex" target="_blank" rel="noopener noreferrer"
              class="block w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white text-center font-semibold rounded-full transition-colors">
             Bei DocMorris kaufen
           </a>
         </div>

         <!-- M√ºller -->
         <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
           <div class="flex items-center gap-4 mb-4">
             <div class="w-16 h-16 bg-neutral-100 rounded-lg flex items-center justify-center">
               <span class="text-2xl font-bold text-orange-600">M</span>
             </div>
             <div>
               <h3 class="font-semibold text-lg">M√ºller</h3>
               <p class="text-sm text-neutral-600">Online & in √ºber 560 Filialen</p>
             </div>
           </div>
           <a href="https://www.mueller.de/search/?text=elmex" target="_blank" rel="noopener noreferrer"
              class="block w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white text-center font-semibold rounded-full transition-colors">
             Bei M√ºller kaufen
           </a>
         </div>

         <!-- REWE -->
         <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
           <div class="flex items-center gap-4 mb-4">
             <div class="w-16 h-16 bg-neutral-100 rounded-lg flex items-center justify-center">
               <span class="text-2xl font-bold text-red-700">R</span>
             </div>
             <div>
               <h3 class="font-semibold text-lg">REWE</h3>
               <p class="text-sm text-neutral-600">Online & in Superm√§rkten</p>
             </div>
           </div>
           <a href="https://shop.rewe.de/products/search?search=elmex" target="_blank" rel="noopener noreferrer"
              class="block w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white text-center font-semibold rounded-full transition-colors">
             Bei REWE kaufen
           </a>
         </div>
       </div>
       ```

    4. Add "Filiale in der N√§he finden" section with map placeholder

    WHY: User feedback from 03-ISSUES.md - "Wo kaufen" Feature aktuell broken
  </action>
  <verify>
    1. Navigate to /beratung/wo-kaufen?product=kariesschutz-zahnpasta
    2. Product name displays correctly
    3. See 6 retailer cards (dm, Rossmann, Amazon, DocMorris, M√ºller, REWE)
    4. Click any retailer button ‚Üí opens retailer site in new tab
    5. All links functional
  </verify>
  <done>"Wo kaufen" page functional with working retailer links and product name display</done>
</task>

<task type="auto">
  <name>Add discount badges to recommended products</name>
  <files>src/components/widgets/PersonalizedRecommendations.astro</files>
  <action>
    Add discount incentive badges to personalized product recommendations:

    1. Add discount badge to each recommended product card:
       ```html
       <div class="product-card relative ...">
         <!-- Discount Badge (top-right corner) -->
         <div class="absolute top-4 right-4 z-10">
           <div class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-semibold shadow-lg">
             10% Rabatt
           </div>
         </div>

         <!-- Product image and details -->
         ...
       </div>
       ```

    2. Add promotional text below product cards:
       ```html
       <p class="text-sm text-neutral-600 text-center mt-6 italic">
         Damit Sie das neue Produkt ausprobieren k√∂nnen, erhalten Sie 10% Rabatt auf Ihre erste Bestellung.
       </p>
       ```

    3. Make discount codes work:
       - Generate unique discount code in localStorage when user views recommendation
       - Display code: `ELMEX{concern.toUpperCase()}10` (e.g., ELMEXSENSITIVE10)
       - Add "Code kopieren" button that copies to clipboard
       - Note: "Einl√∂sbar bei teilnehmenden H√§ndlern"

    4. Styling considerations:
       - Discount badge should stand out but not overwhelm product image
       - Use elmex red (#D32F2F) for discount badge
       - Subtle animation on hover (pulse or scale)

    WHY: Per PROJECT.md - "Rabatt auf Empfehlungen anbieten ('Damit Sie das neue Produkt ausprobieren k√∂nnen')"
  </action>
  <verify>
    1. Complete quiz with concern='sensitivity'
    2. Navigate to homepage
    3. See "F√ºr Sie empfohlen" section
    4. Each recommended product has "10% Rabatt" badge
    5. Promotional text visible below products
    6. Discount code displayed and copyable
  </verify>
  <done>Discount badges on recommended products with copyable codes and promotional messaging</done>
</task>

<task type="auto">
  <name>Add cross-product recommendations on product detail pages</name>
  <files>src/pages/produkte/kariesschutz-zahnpasta.astro, src/pages/produkte/sensitive-zahnpasta.astro</files>
  <action>
    Add "Kunden kauften auch" section to product detail pages:

    1. Create recommendations section at bottom of product page (before footer):
       ```html
       <section class="container mx-auto px-4 my-16">
         <h2 class="text-3xl font-brand font-bold text-neutral-900 mb-8">
           Passende Produkte
         </h2>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
           <!-- Recommendation 1: Matching product line -->
           <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
             <div class="relative">
               <img src="/products/kariesschutz-mundspuelung/kariesschutz-mundspuelung_01.png"
                    alt="elmex KARIESSCHUTZ Mundsp√ºlung"
                    class="w-full h-48 object-contain mb-4 rounded-xl bg-neutral-50" />
               <div class="absolute top-2 right-2 bg-green-600 text-white px-2 py-1 rounded-full text-xs font-semibold">
                 Empfohlen
               </div>
             </div>
             <h3 class="font-semibold text-lg text-neutral-900 mb-2">
               elmex KARIESSCHUTZ Mundsp√ºlung
             </h3>
             <p class="text-sm text-neutral-600 mb-4">
               Erg√§nzender Schutz f√ºr schwer erreichbare Stellen
             </p>
             <div class="flex gap-2">
               <a href="/produkte/kariesschutz-mundspuelung" class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark text-white text-center rounded-full text-sm transition-colors">
                 Details
               </a>
               <a href="/beratung/wo-kaufen?product=kariesschutz-mundspuelung" class="px-4 py-2 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 text-center rounded-full text-sm transition-colors">
                 Kaufen
               </a>
             </div>
           </div>

           <!-- Recommendation 2 & 3: Similar products based on product line -->
           ...
         </div>

         <div class="text-center mt-8">
           <p class="text-sm text-neutral-600 mb-4">
             F√ºr optimalen Schutz empfehlen wir die Kombination aus Zahnpasta, Mundsp√ºlung und passender Zahnb√ºrste.
           </p>
           <a href="/produkte" class="text-primary hover:underline font-medium">
             Alle Produkte ansehen ‚Üí
           </a>
         </div>
       </section>
       ```

    2. Recommendation logic per product:
       - KARIESSCHUTZ Zahnpasta ‚Üí recommend KARIESSCHUTZ Mundsp√ºlung, InterX Zahnb√ºrste, ZAHNFLEISCH Zahnpasta
       - SENSITIVE Zahnpasta ‚Üí recommend SENSITIVE Mundsp√ºlung, SENSITIVE Zahnb√ºrste, SENSITIVE Professional
       - Use "product line" from ProductDetail interface to match products

    3. Add to both existing product pages

    4. Consider adding personalization:
       - If user has quiz data with different concern, show one product matching their concern
       - Example: Viewing KARIESSCHUTZ but quiz says concern='sensitivity' ‚Üí include 1 SENSITIVE product
  </action>
  <verify>
    1. Navigate to /produkte/kariesschutz-zahnpasta
    2. Scroll to bottom
    3. See "Passende Produkte" section with 3 recommendations
    4. Products from same product line or complementary
    5. Click "Details" ‚Üí navigates to product page
    6. Click "Kaufen" ‚Üí navigates to wo-kaufen with product
  </verify>
  <done>Cross-product recommendations on product detail pages with matching product line suggestions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] "Wo kaufen" page functional with retailer links
- [ ] Product name displays when accessed via ?product={slug}
- [ ] All retailer buttons open correct search URLs
- [ ] Discount badges on recommended products
- [ ] Discount codes copyable to clipboard
- [ ] Cross-product recommendations on product pages
- [ ] npm run dev starts without errors
- [ ] All links functional and open in new tabs
</verification>

<success_criteria>
- Fully functional "Wo kaufen" feature with 6 retailer links
- 10% discount badges on personalized recommendations with copyable codes
- Cross-product recommendations on product detail pages
- Professional e-commerce experience with clear purchase paths
- Phase 4 complete - product system fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-produktsystem-ueberarbeitung/04-05-SUMMARY.md`
</output>
