---
phase: 04-produktsystem-ueberarbeitung
plan: 03
subsystem: subscription
tags: [subscription, product-detail, button-integration]

# Dependency graph
requires:
  - phase: 04-produktsystem-ueberarbeitung
    plan: 04-02
    provides: Enhanced product pages with button layout
provides:
  - "Zu Abo hinzufügen" button next to "In Routine aufnehmen"
  - Subscription modal with product preview
  - Integration with existing subscription page
affects: [07-04-subscription-system]

# Tech tracking
tech-stack:
  added: []
  patterns: [subscription-modal, product-to-subscription-flow]

key-files:
  created: []
  modified: [src/pages/produkte/*.astro, src/pages/subscription.astro]
---

<objective>
Add "Zu Abo hinzufügen" button next to "In Routine aufnehmen" on product pages, opening a modal that allows users to add products to their subscription list.

Foundation: Existing subscription.astro page + enhanced product pages from 04-02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Product pages from 04-02:**
- Button group with "Wo kaufen", "Online kaufen", "In Routine aufnehmen"
- "Zu Abo hinzufügen" button placeholder exists

**Existing subscription page:**
@src/pages/subscription.astro

**Requirements from PROJECT.md:**
- "Zu Abo hinzufügen" neben "In Routine aufnehmen" (Phase 4)
- Fulfillment-Provider auswählbar (Amazon, DocMorris, Rossmann Online, etc.) (Phase 7)

Note: Full subscription system with fulfillment providers is Phase 7. This plan focuses on basic "Add to subscription" functionality.
</context>

<tasks>

<task type="auto">
  <name>Implement "Zu Abo hinzufügen" button functionality</name>
  <files>src/pages/produkte/*.astro</files>
  <action>
    Make "Zu Abo hinzufügen" button functional with modal:

    1. Button already exists in layout from 04-02, make it functional:
       ```html
       <button
         id="add-to-subscription"
         data-product-name="{product.name}"
         data-product-slug="{product.slug}"
         class="px-6 py-4 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-medium rounded-full transition-colors">
         Zu Abo hinzufügen
       </button>
       ```

    2. Add modal HTML (hidden by default):
       ```html
       <div id="subscription-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
         <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
           <h3 class="text-2xl font-brand font-bold text-neutral-900 mb-4">
             Zum Abo hinzufügen
           </h3>
           <p class="text-neutral-700 mb-6">
             <span id="modal-product-name" class="font-semibold"></span> wird zu Ihrer Abo-Liste hinzugefügt.
           </p>

           <div class="mb-6">
             <label class="block text-sm font-medium text-neutral-700 mb-2">
               Lieferintervall
             </label>
             <select class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary focus:border-primary">
               <option value="30">Alle 30 Tage</option>
               <option value="60">Alle 60 Tage</option>
               <option value="90">Alle 90 Tage</option>
             </select>
           </div>

           <div class="flex gap-3">
             <button id="confirm-subscription" class="flex-1 px-6 py-3 bg-primary hover:bg-primary-dark text-white font-semibold rounded-full transition-colors">
               Hinzufügen
             </button>
             <button id="cancel-subscription" class="px-6 py-3 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-medium rounded-full transition-colors">
               Abbrechen
             </button>
           </div>
         </div>
       </div>
       ```

    3. Add JavaScript to handle modal:
       ```javascript
       const addToSubBtn = document.getElementById('add-to-subscription');
       const modal = document.getElementById('subscription-modal');
       const modalProductName = document.getElementById('modal-product-name');
       const confirmBtn = document.getElementById('confirm-subscription');
       const cancelBtn = document.getElementById('cancel-subscription');

       addToSubBtn?.addEventListener('click', () => {
         const productName = addToSubBtn.dataset.productName;
         modalProductName.textContent = productName;
         modal?.classList.remove('hidden');
         modal?.classList.add('flex');
       });

       cancelBtn?.addEventListener('click', () => {
         modal?.classList.add('hidden');
         modal?.classList.remove('flex');
       });

       confirmBtn?.addEventListener('click', () => {
         const productSlug = addToSubBtn.dataset.productSlug;
         const interval = document.querySelector('select')?.value;

         // Save to localStorage
         const subscriptions = JSON.parse(localStorage.getItem('elmex-subscriptions') || '[]');
         subscriptions.push({
           slug: productSlug,
           name: modalProductName.textContent,
           interval: parseInt(interval),
           addedAt: new Date().toISOString()
         });
         localStorage.setItem('elmex-subscriptions', JSON.stringify(subscriptions));

         // Close modal and show success
         modal?.classList.add('hidden');
         modal?.classList.remove('flex');
         addToSubBtn.innerHTML = '✓ Im Abo';
         addToSubBtn.disabled = true;

         // Redirect to subscription page after 1s
         setTimeout(() => {
           window.location.href = '/subscription';
         }, 1000);
       });
       ```

    4. Apply to both product pages (kariesschutz-zahnpasta, sensitive-zahnpasta)
  </action>
  <verify>
    1. Navigate to /produkte/kariesschutz-zahnpasta
    2. Click "Zu Abo hinzufügen" button
    3. Modal opens with product name
    4. Select interval (30/60/90 days)
    5. Click "Hinzufügen"
    6. Button changes to "✓ Im Abo"
    7. Redirects to /subscription page
    8. Product appears in subscription list
  </verify>
  <done>"Zu Abo hinzufügen" button functional with modal, saves to localStorage, redirects to subscription page</done>
</task>

<task type="auto">
  <name>Update subscription page to display added products</name>
  <files>src/pages/subscription.astro</files>
  <action>
    Enhance subscription page to read from localStorage and display subscribed products:

    1. Add client-side script to load subscriptions:
       ```javascript
       document.addEventListener('DOMContentLoaded', () => {
         const subscriptions = JSON.parse(localStorage.getItem('elmex-subscriptions') || '[]');
         const container = document.getElementById('subscription-list');

         if (subscriptions.length === 0) {
           container.innerHTML = `
             <div class="text-center py-12">
               <p class="text-neutral-600 mb-4">Sie haben noch keine Produkte in Ihrem Abo.</p>
               <a href="/produkte" class="text-primary hover:underline">Produkte entdecken</a>
             </div>
           `;
           return;
         }

         subscriptions.forEach(sub => {
           const card = document.createElement('div');
           card.className = 'bg-white rounded-xl p-6 shadow-lg';
           card.innerHTML = `
             <div class="flex items-start justify-between">
               <div>
                 <h3 class="text-lg font-semibold text-neutral-900">${sub.name}</h3>
                 <p class="text-sm text-neutral-600 mt-1">Alle ${sub.interval} Tage</p>
               </div>
               <button class="remove-subscription text-red-600 hover:text-red-700" data-slug="${sub.slug}">
                 Entfernen
               </button>
             </div>
           `;
           container.appendChild(card);
         });

         // Handle remove buttons
         document.querySelectorAll('.remove-subscription').forEach(btn => {
           btn.addEventListener('click', (e) => {
             const slug = e.target.dataset.slug;
             const filtered = subscriptions.filter(s => s.slug !== slug);
             localStorage.setItem('elmex-subscriptions', JSON.stringify(filtered));
             location.reload();
           });
         });
       });
       ```

    2. Add container div in subscription page:
       ```html
       <section class="container mx-auto px-4 my-12">
         <h2 class="text-3xl font-brand font-bold text-neutral-900 mb-8">
           Ihre Abo-Produkte
         </h2>
         <div id="subscription-list" class="grid gap-4">
           <!-- Populated by JavaScript -->
         </div>
       </section>
       ```

    3. Note for future Phase 7:
       - Add comment: "<!-- Phase 7: Add fulfillment provider selection here -->"
       - Provider selection will be added in Phase 7 (Amazon, DocMorris, Rossmann, etc.)
  </action>
  <verify>
    1. Add products to subscription from product pages
    2. Navigate to /subscription
    3. See list of subscribed products with intervals
    4. Click "Entfernen" on a product
    5. Product removed from list
    6. localStorage updated correctly
  </verify>
  <done>Subscription page displays products from localStorage with remove functionality</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] "Zu Abo hinzufügen" button functional on all product pages
- [ ] Modal opens with product name and interval selection
- [ ] Products save to localStorage on confirm
- [ ] Button state changes to "✓ Im Abo" after adding
- [ ] Subscription page displays added products
- [ ] Remove functionality works on subscription page
- [ ] npm run dev starts without errors
- [ ] No console errors
</verification>

<success_criteria>
- "Zu Abo hinzufügen" button next to "In Routine aufnehmen" on product pages
- Modal workflow for adding products to subscription
- Subscription page displays and manages subscribed products
- localStorage-based persistence working
- Ready for Phase 7 fulfillment provider integration
</success_criteria>

<output>
After completion, create `.planning/phases/04-produktsystem-ueberarbeitung/04-03-SUMMARY.md`
</output>
