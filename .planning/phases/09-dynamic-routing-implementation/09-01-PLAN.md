---
phase: 09-dynamic-routing-implementation
plan: 01
type: execute
---

<objective>
Implement slug-based dynamic routing for product detail pages using Astro's [slug].astro pattern.

Purpose: Replace hardcoded product pages with single dynamic route that loads from JSON metadata.
Output: Working dynamic route at src/pages/produkte/[slug].astro serving all 16 products.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STRUCTURE.md
@.planning/phases/08-product-data-migration/08-01-SUMMARY.md
@src/types/models.ts
@src/pages/produkte/kariesschutz-zahnpasta.astro
@src/components/ProductDetailLayout.astro

**Tech stack available:**
- Astro dynamic routes with getStaticPaths
- TypeScript ProductDetail interface
- File system API for reading JSON

**Established patterns:**
- Dynamic routes: [slug].astro with getStaticPaths
- Product metadata: public/products/{slug}/product-info.json
- Image paths: /products/{slug}/{slug}_01.png

**Constraining decisions:**
- [08-01]: All 16 products have product-info.json metadata
- [01-02]: Slug format uses kebab-case

**Context:**
Currently two hardcoded pages exist: kariesschutz-zahnpasta.astro and sensitive-zahnpasta.astro. These serve as templates for the dynamic implementation. ProductDetailLayout component already exists and accepts ProductDetail props.

Phase 8 created product-info.json for all products. Now create dynamic route that reads JSON files and generates static pages at build time.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dynamic product route with getStaticPaths</name>
  <files>src/pages/produkte/[slug].astro</files>
  <action>
    Create src/pages/produkte/[slug].astro with Astro's dynamic routing pattern.

    Implementation:
    1. Export getStaticPaths() function that:
       - Uses Node.js fs to read public/products/ directory
       - Filters for directories only (excludes files)
       - For each folder, reads product-info.json
       - Parses JSON to ProductDetail interface
       - Returns array of { params: { slug }, props: { product } }

    2. Page component receives props.product as ProductDetail
    3. Imports Layout and ProductDetailLayout components
    4. Passes product data to ProductDetailLayout
    5. Includes CrossProductRecommendations component after main content

    Key implementation details:
    - Use import.meta.glob or fs.readdirSync to get product folders
    - Read JSON with fs.readFileSync + JSON.parse
    - Type assertion: JSON.parse(...) as ProductDetail
    - Handle potential JSON errors with try/catch (log and skip invalid products)
    - SEO: Extract title from product.name, description from product.heroDescription
    - Images: Product images already use /products/{slug}/{slug}_NN.png pattern

    AVOID: Hardcoded product lists. MUST read from file system dynamically.

    WHY: Dynamic approach ensures adding new products only requires creating folder + JSON file, no code changes.
  </action>
  <verify>
    npm run build succeeds, dist/produkte/ contains 16 product HTML files (one per slug)
  </verify>
  <done>
    Dynamic route generates static pages for all 16 products at build time
  </done>
</task>

<task type="auto">
  <name>Task 2: Update internal product links to use dynamic routes</name>
  <files>
    src/components/widgets/PersonalizedRecommendations.astro,
    src/components/CrossProductRecommendations.astro,
    src/pages/dashboard.astro
  </files>
  <action>
    Update all components that generate product links to use /produkte/{slug} format instead of hardcoded page names.

    PersonalizedRecommendations.astro:
    - Line ~146-150: Update product card hrefs from hardcoded to dynamic
    - Ensure recommendation.url or similar uses /produkte/${product.slug} pattern

    CrossProductRecommendations.astro:
    - Update product hrefs to /produkte/${product.slug}

    dashboard.astro:
    - Search for any product links in routine section
    - Update to /produkte/${productSlug} format

    Pattern:
    - Before: href="/produkte/kariesschutz-zahnpasta"
    - After: href={`/produkte/${product.slug}`}

    AVOID: Mixing hardcoded and dynamic links. All product references MUST use slug-based URLs.

    WHY: Ensures consistency across site. When dynamic route is live, all links work correctly.
  </action>
  <verify>
    grep -r "produkte/kariesschutz-zahnpasta" src/components/ src/pages/ returns no hardcoded product page references (excluding the old .astro files)
  </verify>
  <done>
    All internal product links use dynamic /produkte/{slug} format, no hardcoded product page references remain
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Dynamic product routing system serving all 16 products</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:4321/produkte/kariesschutz-zahnpasta (should load from JSON)
    3. Visit: http://localhost:4321/produkte/elmexjunior (new product, should work)
    4. Visit: http://localhost:4321/produkte/elmexzahnbuerste (toothbrush product)
    5. Test: Click product links from homepage recommendations widget
    6. Verify: All product images load correctly (/products/{slug}/{slug}_01.png pattern)
    7. Verify: Product details (name, description, benefits, ingredients) display correctly
    8. Verify: "Wo kaufen" links work on product pages
    9. Check console: No 404 errors for product routes
    10. Test: Build with npm run build, verify dist/produkte/ contains all 16 HTML files
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Dynamic route [slug].astro exists and implements getStaticPaths
- [ ] Build generates 16 product HTML files in dist/produkte/
- [ ] All internal product links updated to /produkte/{slug} format
- [ ] No hardcoded product page references remain (grep verification passes)
- [ ] Dev server serves all products correctly via dynamic route
</verification>

<success_criteria>

- Dynamic routing implementation complete
- All 16 products accessible via /produkte/{slug} URLs
- Product data loaded from JSON files at build time
- All internal links updated to use slug-based URLs
- Human verification confirms functionality
  </success_criteria>

<output>
After completion, create `.planning/phases/09-dynamic-routing-implementation/09-01-SUMMARY.md`:

# Phase 9 Plan 1: Dynamic Routing Implementation Summary

**Implemented slug-based dynamic routing for all product detail pages**

## Accomplishments

- Created dynamic route src/pages/produkte/[slug].astro with getStaticPaths
- Generates static HTML for all 16 products at build time
- Updated PersonalizedRecommendations, CrossProductRecommendations, dashboard to use dynamic links
- Eliminated hardcoded product page references
- All products now served from single route reading JSON metadata

## Files Created/Modified

- `src/pages/produkte/[slug].astro` - Dynamic product detail route (NEW)
- `src/components/widgets/PersonalizedRecommendations.astro` - Updated product links
- `src/components/CrossProductRecommendations.astro` - Updated product links
- `src/pages/dashboard.astro` - Updated routine product links

## Decisions Made

- getStaticPaths reads from public/products/ directory at build time
- Invalid JSON files logged but don't break build (graceful degradation)
- Image paths constructed dynamically: /products/{slug}/{slug}_01.png
- SEO metadata extracted from product.name and product.heroDescription

## Issues Encountered

None

## Next Step

Ready for Phase 10 (Products Overview Refactor)
</output>
