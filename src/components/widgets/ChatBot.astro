<div
  id="chatbot-widget"
  class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-[9999]"
>
  <div
    id="chatbot-window"
    class="
      absolute bottom-16 right-0
      w-[calc(100vw-2rem)] sm:w-96
      max-w-[400px]
      bg-white rounded-2xl shadow-2xl border border-neutral-200 overflow-hidden
      transition-all duration-300 ease-out
      opacity-0 invisible translate-y-4 scale-95 pointer-events-none
    "
  >
    <div class="bg-primary text-white p-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
          </svg>
        </div>
        <div>
          <h3 class="font-bold">elmex Assistent</h3>
          <p class="text-xs text-white/80">Wir helfen gerne!</p>
        </div>
      </div>
      <button id="chatbot-close" type="button" class="hover:bg-white/10 p-2 rounded-lg transition-colors cursor-pointer">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div class="p-4 h-80 overflow-y-auto bg-neutral-50">
      <div class="space-y-3">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-neutral-100">
          <p class="text-sm text-neutral-700 mb-3">
            Hallo! Ich bin Ihr elmex Assistent. Wie kann ich Ihnen heute helfen?
          </p>
          <div class="space-y-2">
            <a href="/beratung/produktfinder" class="block w-full text-left px-3 py-2 bg-primary/5 hover:bg-primary/10 rounded-lg text-sm text-primary font-medium transition-colors">
              üîç Produktempfehlung finden
            </a>
            <a href="/fragen" class="block w-full text-left px-3 py-2 bg-primary/5 hover:bg-primary/10 rounded-lg text-sm text-primary font-medium transition-colors">
              ‚ùì FAQ durchsuchen
            </a>
            <a href="/beratung" class="block w-full text-left px-3 py-2 bg-primary/5 hover:bg-primary/10 rounded-lg text-sm text-primary font-medium transition-colors">
              üí¨ Pers√∂nliche Beratung
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="p-3 bg-white border-t border-neutral-200">
      <div class="flex gap-2">
        <input
          type="text"
          id="chatbot-input"
          placeholder="Ihre Frage eingeben..."
          class="flex-1 px-4 py-2 border border-neutral-200 rounded-lg text-sm bg-neutral-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
        />
        <button id="chatbot-send" class="bg-primary hover:bg-primary-dark text-white p-2 rounded-lg transition-colors active:scale-95">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
        </button>
      </div>
      <p class="text-[10px] text-neutral-400 text-center mt-2">Demo-Modus ‚Äì Eingaben werden nicht verarbeitet</p>
    </div>
  </div>

  <button
    id="chatbot-toggle"
    type="button"
    class="flex items-center gap-3 bg-primary text-white h-12 px-5 rounded-full shadow-lg hover:bg-primary-dark transition-colors duration-300 cursor-pointer"
  >
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
    </svg>
    <span class="font-semibold text-sm">Hilfe</span>
  </button>
</div>

<style>
  #chatbot-widget.is-open #chatbot-window {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }
</style>

<script is:inline>
  (function() {
    function init() {
      const widget = document.getElementById('chatbot-widget');
      const toggle = document.getElementById('chatbot-toggle');
      const closeBtn = document.getElementById('chatbot-close');

      if (!widget || !toggle) return;

      // Clone um alte Listener zu entfernen
      const newToggle = toggle.cloneNode(true);
      toggle.parentNode.replaceChild(newToggle, toggle);

      const newClose = closeBtn ? closeBtn.cloneNode(true) : null;
      if (closeBtn && newClose) {
        closeBtn.parentNode.replaceChild(newClose, closeBtn);
      }

      function openChat() {
        widget.classList.add('is-open');
      }

      function closeChat() {
        widget.classList.remove('is-open');
      }

      newToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        if (widget.classList.contains('is-open')) {
          closeChat();
        } else {
          openChat();
        }
      });

      if (newClose) {
        newClose.addEventListener('click', function(e) {
          e.stopPropagation();
          closeChat();
        });
      }

      // Klick au√üerhalb schlie√üt
      document.addEventListener('click', function(e) {
        if (widget.classList.contains('is-open') && !widget.contains(e.target)) {
          closeChat();
        }
      });

      // ESC zum Schlie√üen
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && widget.classList.contains('is-open')) {
          closeChat();
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    document.addEventListener('astro:page-load', init);
  })();
</script>
