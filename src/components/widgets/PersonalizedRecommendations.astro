---
import { getImage } from "astro:assets";

// 1. Import all product images using Vite's glob import
// Note: The path pattern must match your actual folder structure
const imageFiles = import.meta.glob<{ default: ImageMetadata }>('/src/assets/products/**/*.{png,jpg,jpeg,webp}');

// 2. Define the database here (Server-Side) so we can process images
const rawProducts = [
  {
    key: 'elmexgelee',
    name: 'elmex gelée',
    slug: 'elmexgelee',
    description: 'Intensive Fluoridierung zur Kariesvorbeugung',
    url: '/produkte/elmexgelee',
    // We construct the path string to match the glob above
    imagePath: '/src/assets/products/elmexgelee/elmexgelee_1.png',
    category: 'cavity',
    icon: 'shield'
  },
  {
    key: 'elmexwhite',
    name: 'elmex White',
    slug: 'elmexwhite',
    description: 'Wirksamer Schutz vor neuen Verfärbungen',
    url: '/produkte/elmexwhite',
    imagePath: '/src/assets/products/elmexwhite/elmexwhite_1.png',
    category: 'whitening',
    icon: 'sparkles'
  },
  {
    key: 'elmexzahnhoelzer',
    name: 'elmex Zahnhölzer',
    slug: 'elmexzahnhoelzer',
    description: 'Sanfte Reinigung für gesunde Zähne',
    url: '/produkte/elmexzahnhoelzer',
    imagePath: '/src/assets/products/elmexzahnhoelzer/elmexzahnhoelzer_1.png',
    category: 'cavity',
    icon: 'leaf'
  },
  {
    key: 'elmexkariesschutzzahnpasta',
    name: 'elmex KARIESSCHUTZ Zahnpasta',
    slug: 'elmexkariesschutzzahnpasta',
    description: 'Ergänzender Schutz für schwer erreichbare Stellen',
    url: '/produkte/elmexkariesschutzzahnpasta',
    imagePath: '/src/assets/products/elmexkariesschutzzahnpasta/elmexkariesschutzzahnpasta_1.png',
    category: 'cavity',
    icon: 'shield'
  },
  {
    key: 'elmexkariesschutzzahnbuerste',
    name: 'elmex Expert Präzision Zahnbürste',
    slug: 'elmexkariesschutzzahnbuerste',
    description: 'Effektive Reinigung für gesunde Zähne',
    url: '/produkte/elmexkariesschutzzahnbuerste',
    imagePath: '/src/assets/products/elmexkariesschutzzahnbuerste/elmexkariesschutzzahnbuerste_1.png',
    category: 'cavity',
    icon: 'brush'
  },
  {
    key: 'elmexsensitivespuelung',
    name: 'elmex SENSITIVE Mundspülung',
    slug: 'elmexsensitivespuelung',
    description: 'Sanfte Pflege für empfindliche Zähne',
    url: '/produkte/elmexsensitivespuelung',
    imagePath: '/src/assets/products/elmexsensitivespuelung/elmexsensitivespuelung_1.png',
    category: 'sensitivity',
    icon: 'droplet'
  },
  {
    key: 'elmexsensitiveprofessional',
    name: 'elmex SENSITIVE PROFESSIONAL',
    slug: 'elmexsensitiveprofessional',
    description: 'Sofortige und langanhaltende Schmerzlinderung',
    url: '/produkte/elmexsensitiveprofessional',
    imagePath: '/src/assets/products/elmexsensitiveprofessional/elmexsensitiveprofessional_1.png',
    category: 'sensitivity',
    icon: 'sparkles'
  },
  {
    key: 'elmexsensitivezahnpasta',
    name: 'elmex SENSITIVE Zahnpasta',
    slug: 'elmexsensitivezahnpasta',
    description: 'Sofortige und langanhaltende Schmerzlinderung',
    url: '/produkte/elmexsensitivezahnpasta',
    imagePath: '/src/assets/products/elmexsensitivezahnpasta/elmexsensitivezahnpasta_1.png',
    category: 'sensitivity',
    icon: 'sparkles'
  },
  {
    key: 'elmexsensitivezahnbuerste',
    name: 'elmex SENSITIVE Zahnbürste',
    slug: 'elmexsensitivezahnbuerste',
    description: 'Besonders weiche Borsten für empfindliche Zähne',
    url: '/produkte/elmexsensitivezahnbuerste',
    imagePath: '/src/assets/products/elmexsensitivezahnbuerste/elmexsensitivezahnbuerste_1.png',
    category: 'sensitivity',
    icon: 'brush'
  },
  {
    key: 'elmexoptischmelzspuelung',
    name: 'elmex OPTI-SCHMELZ Mundspülung',
    slug: 'elmexoptischmelzspuelung',
    description: 'Sanfte Pflege für empfindliche Zähne',
    url: '/produkte/elmexoptischmelzspuelung',
    imagePath: '/src/assets/products/elmexoptischmelzspuelung/elmexoptischmelzspuelung_1.png',
    category: 'enamel',
    icon: 'droplet'
  },
  {
    key: 'elmexoptischmelzzahnbuerste',
    name: 'elmex OPTI-SCHMELZ Zahnbürste',
    slug: 'elmexoptischmelzzahnbuerste',
    description: 'Effektive Reinigung für gesunde Zähne',
    url: '/produkte/elmexoptischmelzzahnbuerste',
    imagePath: '/src/assets/products/elmexoptischmelzzahnbuerste/elmexoptischmelzzahnbuerste_1.png',
    category: 'enamel',
    icon: 'brush'
  },
  {
    key: 'elmexoptischmelzzahnpasta',
    name: 'elmex OPTI-SCHMELZ Zahnpasta',
    slug: 'elmexoptischmelzzahnpasta',
    description: 'Intensive Fluoridierung zur Kariesvorbeugung',
    url: '/produkte/elmexoptischmelzzahnpasta',
    imagePath: '/src/assets/products/elmexoptischmelzzahnpasta/elmexoptischmelzzahnpasta_1.png',
    category: 'enamel',
    icon: 'shield'
  },
  {
    key: 'elmexjuniorzahnpasta',
    name: 'elmex JUNIOR Zahnpasta',
    slug: 'elmexjuniorzahnpasta',
    description: 'Die erste Zahnpasta für Kinder ab 6 Jahren',
    url: '/produkte/elmexjuniorzahnpasta',
    imagePath: '/src/assets/products/elmexjuniorzahnpasta/elmexjuniorzahnpasta_1.png',
    category: 'junior',
    icon: 'baby'
  },
  {
    key: 'elmexjuniorspuelung',
    name: 'elmex JUNIOR Mundspülung',
    slug: 'elmexjuniorspuelung',
    description: 'Die erste Mundspülung für Kinder ab 6 Jahren',
    url: '/produkte/elmexjuniorspuelung',
    imagePath: '/src/assets/products/elmexjuniorspuelung/elmexjuniorspuelung_1.png',
    category: 'junior',
    icon: 'droplet'
  }
];

// 3. Process images: Resolve paths to optimized URLs
const processedProducts = await Promise.all(rawProducts.map(async (product) => {
  const imageLoader = imageFiles[product.imagePath];
  
  if (!imageLoader) {
    console.warn(`[Recommendations] Image not found for ${product.name}: ${product.imagePath}`);
    return { ...product, image: '' }; // Fallback or empty string
  }

  const imageModule = await imageLoader();
  // Optimize image (resize to 300x300 or similar for widget)
  const optimizedImage = await getImage({
    src: imageModule.default,
    width: 300,
    height: 300,
    format: 'webp'
  });

  return {
    ...product,
    image: optimizedImage.src // This is now a clean URL string
  };
}));

// Convert array back to object map for the script to use
const productDatabase = processedProducts.reduce((acc, curr) => {
  acc[curr.key] = curr;
  return acc;
}, {});
---

<div id="personalized-widget" class="hidden relative bg-gradient-to-br from-primary/5 to-primary/10 rounded-2xl p-8 my-12 border border-primary/20">
  <div class="mb-8">
    <div class="flex flex-col items-center mb-6">
      <div class="flex -space-x-2 mb-3">
        <img src="/assets/experts/expert-1.png" alt="Zahnexperte" class="w-12 h-12 rounded-full border-2 border-white shadow-md object-cover" />
        <img src="/assets/experts/expert-2.png" alt="Zahnexperte" class="w-12 h-12 rounded-full border-2 border-white shadow-md object-cover" />
        <img src="/assets/experts/expert-3.png" alt="Zahnexperte" class="w-12 h-12 rounded-full border-2 border-white shadow-md object-cover" />
      </div>
      <p class="text-sm text-neutral-600">Empfohlen von Zahnexperten</p>
    </div>
    <div class="text-center">
      <h3 class="text-2xl md:text-3xl font-brand font-bold text-neutral-900 mb-2">
        Für Sie empfohlen
      </h3>
      <p id="personalization-reason" class="text-neutral-600">
        Basierend auf Ihren bisherigen Besuchen
      </p>
    </div>
    <button id="dismiss-recommendations" class="absolute top-4 right-4 text-neutral-400 hover:text-neutral-600 transition-colors" aria-label="Empfehlungen ausblenden">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>
  <div class="mx-auto">
    <div id="recommendations-container" class="mx-auto max-w-max flex flex-col md:flex-row md:flex-wrap justify-center gap-6 px-4 md:px-0">
      </div>
  </div>
  <div class="mt-8 text-center">
    <p class="text-sm text-neutral-600 mb-4 italic">
      Damit Sie das neue Produkt ausprobieren können, erhalten Sie 10% Rabatt auf Ihre erste Bestellung.
    </p>
    <div class="inline-flex items-center gap-3 bg-white px-6 py-3 rounded-full border-2 border-primary shadow-md">
      <span class="text-sm text-neutral-600">Ihr Rabattcode:</span>
      <code id="discount-code" class="text-lg font-bold text-primary bg-primary/10 px-4 py-1 rounded-lg"></code>
      <button id="copy-discount-code" class="px-4 py-1 bg-primary hover:bg-primary-dark text-white text-sm font-semibold rounded-lg transition-colors" title="Code kopieren">
        Kopieren
      </button>
    </div>
    <p class="text-xs text-neutral-500 mt-2">Einlösbar bei teilnehmenden Händlern</p>
  </div>
  <div class="mt-6 text-center">
    <a href="/beratung/produktfinder" class="inline-flex items-center text-sm text-primary hover:text-primary-dark hover:underline transition-colors">
      Neue Empfehlung erhalten →
    </a>
  </div>
</div>

<script define:vars={{ productDatabase }}>
  // NOTE: productDatabase is now available here as a global variable injected by Astro!

  // --- Type Declarations ---
  // (We don't need to declare ProductMap here anymore since the data is injected)
  
  // Icon library
  const icons = {
    'shield': '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>',
    'sparkles': '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>',
    'heart': '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>',
    'baby': '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
    'droplet': '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19c1.5 0 3-.5 4-2"></path></svg>',
    'waves': '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>',
    'brush': '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>',
    'flower': '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>'
  };

  function getUserProfile() {
    const visitCount = parseInt(localStorage.getItem('elmex_visit_count') || '0');
    const firstVisit = parseInt(localStorage.getItem('elmex_first_visit') || Date.now().toString());
    const lastVisit = parseInt(localStorage.getItem('elmex_last_visit') || Date.now().toString());
    const viewedProducts = JSON.parse(localStorage.getItem('elmex_viewed_products') || '[]');
    const quizResultStr = localStorage.getItem('elmex_quiz_results');
    const quizResult = quizResultStr ? JSON.parse(quizResultStr) : null;

    return {
      visitCount,
      firstVisit,
      lastVisit,
      viewedProducts,
      quizCompleted: !!quizResult,
      quizResult
    };
  }

  function getRecommendations(profile) {
    const recommendations = [];

    // Helper to safely add product if it exists in database
    const addProduct = (key) => {
      // productDatabase is now passed via define:vars
      const product = productDatabase[key];
      if (product) {
        recommendations.push(product);
      }
    };

    // Strategy 1: Quiz-based recommendations
    if (profile.quizCompleted && profile.quizResult) {
      const answersMap = {};
      if (Array.isArray(profile.quizResult.answers)) {
        profile.quizResult.answers.forEach((item) => {
          answersMap[item.questionId] = item.answer;
        });
      }

      // Recommend based on dental concerns
      if (answersMap.dentalConcerns) {
        const concerns = Array.isArray(answersMap.dentalConcerns) ? answersMap.dentalConcerns : [answersMap.dentalConcerns];

        if (concerns.includes('sensitive-teeth')) {
          addProduct('elmexsensitiveprofessional');
          addProduct('elmexsensitivespuelung');
        } else if (concerns.includes('cavity-protection')) {
          addProduct('elmexkariesschutzzahnpasta');
          addProduct('elmexgelee');
        } else if (concerns.includes('gum-health')) {
          addProduct('elmexkariesschutzzahnpasta');
          addProduct('elmexkariesschutzzahnbuerste');
        } else if (concerns.includes('whitening')) {
          addProduct('elmexwhite');
          addProduct('elmexzahnhoelzer');
        }
      }

      // Recommend for children
      if (answersMap.childAge || answersMap.start === 'child') {
        addProduct('elmexjuniorzahnpasta');
        addProduct('elmexjuniorspuelung');
      }

      // Recommend based on symptoms
      if (answersMap.symptoms) {
        const symptoms = Array.isArray(answersMap.symptoms) ? answersMap.symptoms : [answersMap.symptoms];

        if (symptoms.includes('sensitivity')) {
          addProduct('elmexsensitiveprofessional');
        } else if (symptoms.includes('bleeding') || symptoms.includes('inflammation')) {
          addProduct('elmexkariesschutzzahnpasta');
        }
      }
    }

    // Strategy 2: Browsing history-based
    if (recommendations.length < 3 && profile.viewedProducts.length > 0) {
      Object.values(productDatabase).forEach(product => {
        if (product && !recommendations.some(r => r.name === product.name) && recommendations.length < 3) {
          recommendations.push(product);
        }
      });
    }

    // Strategy 3: Popular products (default)
    if (recommendations.length === 0) {
      addProduct('elmexsensitiveprofessional');
      addProduct('elmexkariesschutzzahnpasta');
      addProduct('elmexwhite');
    }

    return recommendations.slice(0, 4);
  }

  function renderRecommendations(recommendations, profile) {
    const container = document.getElementById('recommendations-container');
    const widget = document.getElementById('personalized-widget');
    const reason = document.getElementById('personalization-reason');

    if (!container || !widget || !reason) return;
    if (recommendations.length === 0) return;

    // Determine personalization reason
    let reasonText = 'Basierend auf Ihren bisherigen Besuchen';
    if (profile.quizCompleted) {
      reasonText = 'Basierend auf Ihren Produktfinder-Ergebnissen';
    } else if (profile.viewedProducts.length > 0) {
      reasonText = 'Basierend auf Ihren angesehenen Produkten';
    }
    reason.textContent = reasonText;

    container.innerHTML = recommendations.map(product => `
      <a
        href="${product.url}"
        class="recommendation-card relative bg-white rounded-xl border-2 border-neutral-200 hover:border-primary hover:shadow-lg transition-all group mx-auto flex flex-col overflow-hidden w-full md:w-72 lg:w-80 shrink-0"
      >
        <div class="absolute top-4 right-4 z-10">
          <div class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-semibold shadow-lg animate-pulse-subtle">
            10% Rabatt
          </div>
        </div>

        <div class="h-48 w-full overflow-hidden bg-gray-50 flex items-center justify-center">
          <img 
            src="${product.image}" 
            alt="${product.name}" 
            class="h-full w-full object-cover group-hover:scale-105 transition-transform duration-500"
            onerror="this.src='https://placehold.co/300x300?text=Produktbild'; this.style.objectFit='cover';"
          />
        </div>

        <div class="p-6 flex flex-col flex-grow">
          <h4 class="font-brand font-semibold text-lg mb-2 text-neutral-900 leading-tight">${product.name}</h4>
          <p class="text-sm text-neutral-600 mb-4 line-clamp-2">${product.description}</p>
          
          <div class="mt-auto flex items-center text-primary font-medium text-sm group-hover:gap-2 transition-all">
            <span>Mehr erfahren</span>
            <svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </div>
      </a>
    `).join('');

    widget.classList.remove('hidden');
    setTimeout(() => {
      widget.style.opacity = '0';
      widget.style.transform = 'translateY(20px)';
      widget.style.transition = 'all 0.5s ease-out';
      setTimeout(() => {
        widget.style.opacity = '1';
        widget.style.transform = 'translateY(0)';
      }, 10);
    }, 100);
  }

  function trackProductView(productName, productUrl) {
    const viewedProducts = JSON.parse(localStorage.getItem('elmex_viewed_products') || '[]');
    viewedProducts.push({
      name: productName,
      url: productUrl,
      timestamp: Date.now()
    });
    const recentViews = viewedProducts.slice(-10);
    localStorage.setItem('elmex_viewed_products', JSON.stringify(recentViews));
  }

  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', () => {
    const currentVisits = parseInt(localStorage.getItem('elmex_visit_count') || '0');
    localStorage.setItem('elmex_visit_count', (currentVisits + 1).toString());
    localStorage.setItem('elmex_last_visit', Date.now().toString());
    if (!localStorage.getItem('elmex_first_visit')) {
      localStorage.setItem('elmex_first_visit', Date.now().toString());
    }

    const currentPath = window.location.pathname;
    if (currentPath.includes('/produkte/')) {
      const productName = document.querySelector('h1')?.textContent || 'Produkt';
      trackProductView(productName, currentPath);
    }

    const profile = getUserProfile();
    const recommendations = getRecommendations(profile);
    renderRecommendations(recommendations, profile);

    const generateDiscountCode = (profile) => {
      let concern = 'ELMEX';
      if (profile.quizCompleted && profile.quizResult) {
        const answersMap = {};
        if (Array.isArray(profile.quizResult.answers)) {
          profile.quizResult.answers.forEach((item) => {
            answersMap[item.questionId] = item.answer;
          });
        }
        if (answersMap.dentalConcerns) {
          const concerns = Array.isArray(answersMap.dentalConcerns) ? answersMap.dentalConcerns : [answersMap.dentalConcerns];
          if (concerns.includes('sensitive-teeth')) concern = 'SENSITIVE';
          else if (concerns.includes('cavity-protection')) concern = 'KARIES';
          else if (concerns.includes('gum-health')) concern = 'ZAHNFLEISCH';
          else if (concerns.includes('whitening')) concern = 'WHITE';
        }
        if (answersMap.childAge || answersMap.start === 'child') {
          concern = 'JUNIOR';
        }
      }
      return `ELMEX${concern}10`;
    };

    const discountCode = generateDiscountCode(profile);
    const discountCodeEl = document.getElementById('discount-code');
    if (discountCodeEl) discountCodeEl.textContent = discountCode;

    const copyBtn = document.getElementById('copy-discount-code');
    copyBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      navigator.clipboard.writeText(discountCode).then(() => {
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'Kopiert!';
        copyBtn.classList.add('bg-green-600');
        copyBtn.classList.remove('bg-primary', 'hover:bg-primary-dark');
        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.classList.remove('bg-green-600');
          copyBtn.classList.add('bg-primary', 'hover:bg-primary-dark');
        }, 2000);
      });
    });

    const dismissBtn = document.getElementById('dismiss-recommendations');
    dismissBtn?.addEventListener('click', () => {
      const widget = document.getElementById('personalized-widget');
      if (widget) {
        widget.style.opacity = '0';
        widget.style.transform = 'translateY(-20px)';
        setTimeout(() => { widget.classList.add('hidden'); }, 300);
      }
      sessionStorage.setItem('elmex_recommendations_dismissed', 'true');
    });

    if (sessionStorage.getItem('elmex_recommendations_dismissed')) {
      const widget = document.getElementById('personalized-widget');
      widget?.classList.add('hidden');
    }
  });

  window.trackElmexProductView = trackProductView;
</script>

<style>
  #personalized-widget {
    opacity: 0;
    transform: translateY(20px);
  }

  .recommendation-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .recommendation-card:hover {
    transform: translateY(-4px);
  }

  @keyframes pulse-subtle {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.9;
      transform: scale(1.05);
    }
  }

  .animate-pulse-subtle {
    animation: pulse-subtle 2s ease-in-out infinite;
  }
</style>