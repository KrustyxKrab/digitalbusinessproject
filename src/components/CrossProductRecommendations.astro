---
// Cross-Product Recommendations Component
interface Product {
  slug: string;
  name: string;
  description: string;
  image: string;
}

interface Props {
  currentProductLine: string;
  currentProductSlug: string;
}

const { currentProductLine, currentProductSlug } = Astro.props;

// Product database for recommendations
const allProducts: Record<string, Product[]> = {
  'kariesschutz': [
    {
      slug: 'kariesschutz-mundspuelung',
      name: 'elmex KARIESSCHUTZ Mundspülung',
      description: 'Ergänzender Schutz für schwer erreichbare Stellen',
      image: '/products/kariesschutz-mundspuelung/kariesschutz-mundspuelung_01.png'
    },
    {
      slug: 'zahnbuerste',
      name: 'elmex InterX Zahnbürste',
      description: 'Effektive Reinigung für gesunde Zähne',
      image: '/products/elmexzahnbuerste/elmex_zahnbürste_1.png'
    },
    {
      slug: 'gelee',
      name: 'elmex gelée',
      description: 'Intensive Fluoridierung zur Kariesvorbeugung',
      image: '/products/elmexgelee/elmex_gelée_1.png'
    }
  ],
  'sensitive': [
    {
      slug: 'sensitive-mundspuelung',
      name: 'elmex SENSITIVE Mundspülung',
      description: 'Sanfte Pflege für empfindliche Zähne',
      image: '/products/elmexsensitivemouthwash/elmex_sensitive_mundspülung_1.png'
    },
    {
      slug: 'sensitive-professional',
      name: 'elmex SENSITIVE PROFESSIONAL',
      description: 'Sofortige und langanhaltende Schmerzlinderung',
      image: '/products/elmexsensitiveprofessional/elmex_sensitive_professional_1.png'
    },
    {
      slug: 'zahnbuerste-sensitive',
      name: 'elmex SENSITIVE Zahnbürste',
      description: 'Besonders weiche Borsten für empfindliche Zähne',
      image: '/products/elmexzahnbuerste/elmex_zahnbürste_1.png'
    }
  ]
};

// Get recommendations for current product line, excluding current product
const recommendations = (allProducts[currentProductLine] || [])
  .filter(product => product.slug !== currentProductSlug)
  .slice(0, 3);
---

{recommendations.length > 0 && (
  <section class="container mx-auto px-4 my-16">
    <h2 class="text-3xl font-brand font-bold text-neutral-900 mb-8">
      Passende Produkte
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      {recommendations.map((product) => (
        <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
          <div class="relative">
            <img
              src={product.image}
              alt={product.name}
              class="w-full h-48 object-contain mb-4 rounded-xl bg-neutral-50"
            />
            <div class="absolute top-2 right-2 bg-green-600 text-white px-2 py-1 rounded-full text-xs font-semibold">
              Empfohlen
            </div>
          </div>
          <h3 class="font-semibold text-lg text-neutral-900 mb-2">
            {product.name}
          </h3>
          <p class="text-sm text-neutral-600 mb-4">
            {product.description}
          </p>
          <div class="flex gap-2">
            <a
              href={`/produkte/${product.slug}`}
              class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark text-white text-center rounded-full text-sm transition-colors font-semibold"
            >
              Details
            </a>
            <a
              href={`/beratung/wo-kaufen?product=${product.slug}`}
              class="px-4 py-2 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 text-center rounded-full text-sm transition-colors font-medium"
            >
              Kaufen
            </a>
          </div>
        </div>
      ))}
    </div>

    <div class="text-center mt-8">
      <p class="text-sm text-neutral-600 mb-4">
        Für optimalen Schutz empfehlen wir die Kombination aus Zahnpasta, Mundspülung und passender Zahnbürste.
      </p>
      <a href="/produkte" class="text-primary hover:underline font-medium">
        Alle Produkte ansehen →
      </a>
    </div>
  </section>
)}

<script>
  // Personalized recommendations based on quiz results
  document.addEventListener('DOMContentLoaded', () => {
    const quizResultStr = localStorage.getItem('elmex_quiz_results');

    if (quizResultStr) {
      try {
        const quizResult = JSON.parse(quizResultStr);
        const answersMap: Record<string, any> = {};

        if (Array.isArray(quizResult.answers)) {
          quizResult.answers.forEach((item: any) => {
            answersMap[item.questionId] = item.answer;
          });
        }

        // Get current product line from the page
        const currentPath = window.location.pathname;

        // Check if user has different concern than current product
        if (answersMap.dentalConcerns) {
          const concerns = Array.isArray(answersMap.dentalConcerns)
            ? answersMap.dentalConcerns
            : [answersMap.dentalConcerns];

          // If user has sensitivity concern but viewing kariesschutz product,
          // or vice versa, we could show a hint
          const hasSensitivityConcern = concerns.includes('sensitive-teeth');
          const hasKariesConcern = concerns.includes('cavity-protection');

          if ((hasSensitivityConcern && currentPath.includes('kariesschutz')) ||
              (hasKariesConcern && currentPath.includes('sensitive'))) {
            // Could add a personalized hint here in the future
            console.log('User might be interested in products from their concern category');
          }
        }
      } catch (e) {
        // Silently fail if quiz results are malformed
        console.error('Failed to parse quiz results:', e);
      }
    }
  });
</script>
