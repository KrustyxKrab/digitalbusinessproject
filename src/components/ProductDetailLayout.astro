---
import { Eye, Code } from '@lucide/astro';
import type { ProductDetail } from '@/types/models';

interface Props {
  product: ProductDetail;
  iconComponent?: any;
}

const { product } = Astro.props;

// Generate Schema.org structured data
const schemaProduct = {
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": product.name,
  "description": product.description,
  "brand": { "@type": "Brand", "name": "elmex" },
  "sku": product.sku,
  "offers": {
    "@type": "Offer",
    "price": product.price.toFixed(2),
    "priceCurrency": "EUR",
    "availability": product.availability
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": product.rating.value.toString(),
    "reviewCount": product.rating.count.toString()
  }
};
---

<!-- Vision Switch -->
<div class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-neutral-200 py-4 transition-all">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-center gap-4">
      <div class="flex items-center gap-2 text-sm font-medium text-neutral-600">
        <Eye class="w-4 h-4" />
        <span>Human Focus</span>
      </div>

      <label class="relative inline-block w-16 h-8 cursor-pointer">
        <input type="checkbox" id="vision-switch" class="sr-only peer" />
        <div class="w-full h-full bg-gradient-to-r from-primary to-red-500 rounded-full peer-checked:from-gray-600 peer-checked:to-cyan-600 transition-all"></div>
        <div class="absolute top-1 left-1 w-6 h-6 bg-white rounded-full shadow-lg transition-all peer-checked:translate-x-8 flex items-center justify-center">
          <div class="w-2 h-2 bg-current rounded-full"></div>
        </div>
      </label>

      <div class="flex items-center gap-2 text-sm font-medium text-neutral-600">
        <Code class="w-4 h-4" />
        <span>Crawler Focus</span>
      </div>
    </div>
  </div>
</div>

<!-- HUMAN FOCUS MODE -->
<div id="human-mode" class="transition-all">
  <!-- Product Header Section -->
  <section class="bg-white py-12">
    <div class="container mx-auto px-4">
      <!-- Product Name -->
      <div class="mb-8">
        <h1 class="text-4xl md:text-5xl font-brand font-bold text-neutral-900 mb-2">
          {product.name}
        </h1>
        {product.subtitle && (
          <p class="text-xl text-neutral-600">{product.subtitle}</p>
        )}
      </div>

      <!-- 3 Product Images Above Fold -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <!-- Main Image (Large, Left) -->
        <div class="md:col-span-2">
          <div class="relative aspect-[4/3] rounded-xl overflow-hidden bg-neutral-50">
            <img
              src={`/products/${product.slug}/${product.slug}_01.png`}
              alt={`${product.name} - Hauptbild`}
              class="w-full h-full object-contain"
            />
          </div>
        </div>

        <!-- Images 2 & 3 (Stacked Vertically, Right) -->
        <div class="grid grid-cols-2 md:grid-cols-1 gap-4">
          <div class="relative aspect-[4/3] rounded-xl overflow-hidden bg-neutral-50">
            <img
              src={`/products/${product.slug}/${product.slug}_02.png`}
              alt={`${product.name} - Bild 2`}
              class="w-full h-full object-contain"
            />
          </div>
          <div class="relative aspect-[4/3] rounded-xl overflow-hidden bg-neutral-50">
            <img
              src={`/products/${product.slug}/${product.slug}_03.png`}
              alt={`${product.name} - Bild 3`}
              class="w-full h-full object-contain"
            />
          </div>
        </div>
      </div>

      <!-- Button Group -->
      <div class="flex flex-wrap gap-3 mb-8">
        <a
          href={`/beratung/wo-kaufen?product=${product.slug}`}
          class="px-8 py-4 bg-primary hover:bg-primary-dark text-white font-semibold text-lg rounded-full transition-colors shadow-lg hover:shadow-xl"
        >
          Wo kaufen
        </a>
        <a
          href="#online-retailers"
          class="px-8 py-4 bg-white hover:bg-neutral-50 text-primary font-semibold text-lg rounded-full border-2 border-primary transition-colors"
        >
          Online kaufen
        </a>
        <button
          id="routine-btn"
          class="px-6 py-4 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-medium rounded-full transition-colors"
        >
          <span id="routine-text">In Routine aufnehmen</span>
        </button>
        <button class="px-6 py-4 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-medium rounded-full transition-colors">
          Zu Abo hinzufügen
        </button>
      </div>

      <!-- Product Description -->
      <div class="mb-8">
        <p class="text-lg text-neutral-700 leading-relaxed mb-6">
          {product.description}
        </p>

        <!-- Badge -->
        {product.badge && (
          <div class="inline-block px-4 py-2 bg-primary/10 text-primary rounded-full text-sm font-semibold">
            <span class="flex items-center gap-2">
              <div class="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
              {product.badge.text}
            </span>
          </div>
        )}
      </div>

      <!-- Benefits -->
      {product.benefits && product.benefits.length > 0 && (
        <div class="mb-8">
          <h2 class="text-2xl font-brand font-bold text-neutral-900 mb-4">
            Vorteile
          </h2>
          <ul class="space-y-3">
            {product.benefits.map((benefit) => (
              <li class="flex items-start gap-3">
                <svg class="w-6 h-6 text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span class="text-neutral-700">{benefit}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- AI Matching Score -->
      {product.matchingScore && (
        <div class="p-6 bg-gradient-to-r from-primary/5 to-orange-50 rounded-2xl border border-primary/20 mb-8">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-neutral-900">Passt das zu mir?</h3>
            <div class="text-3xl font-bold gradient-title">{product.matchingScore.percentage}%</div>
          </div>
          <p class="text-sm text-neutral-600 mb-3">
            {product.matchingScore.profile}
          </p>
          {product.matchingScore.note && product.matchingScore.alternativeProduct && (
            <p class="text-xs text-neutral-500 flex items-start gap-2">
              <span class="text-orange-500">ⓘ</span>
              {product.matchingScore.note} <a href={product.matchingScore.alternativeProduct.url} class="text-primary hover:underline">{product.matchingScore.alternativeProduct.name}</a>
            </p>
          )}
        </div>
      )}

      <!-- Online Retailers Section -->
      <div id="online-retailers" class="mb-8">
        <h2 class="text-3xl font-brand font-bold text-neutral-900 mb-6">
          Online kaufen
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <a
            href="https://www.dm.de"
            target="_blank"
            rel="noopener noreferrer"
            class="p-6 bg-white border-2 border-neutral-200 hover:border-primary rounded-xl transition-all hover:shadow-lg group"
          >
            <div class="flex flex-col items-center text-center">
              <div class="text-4xl font-bold text-neutral-800 mb-3">dm</div>
              <button class="mt-2 px-6 py-2 bg-primary text-white rounded-full group-hover:bg-primary-dark transition-colors text-sm font-medium">
                Jetzt kaufen
              </button>
            </div>
          </a>
          <a
            href="https://www.rossmann.de"
            target="_blank"
            rel="noopener noreferrer"
            class="p-6 bg-white border-2 border-neutral-200 hover:border-primary rounded-xl transition-all hover:shadow-lg group"
          >
            <div class="flex flex-col items-center text-center">
              <div class="text-4xl font-bold text-neutral-800 mb-3">Rossmann</div>
              <button class="mt-2 px-6 py-2 bg-primary text-white rounded-full group-hover:bg-primary-dark transition-colors text-sm font-medium">
                Jetzt kaufen
              </button>
            </div>
          </a>
          <a
            href="https://www.amazon.de"
            target="_blank"
            rel="noopener noreferrer"
            class="p-6 bg-white border-2 border-neutral-200 hover:border-primary rounded-xl transition-all hover:shadow-lg group"
          >
            <div class="flex flex-col items-center text-center">
              <div class="text-4xl font-bold text-neutral-800 mb-3">Amazon</div>
              <button class="mt-2 px-6 py-2 bg-primary text-white rounded-full group-hover:bg-primary-dark transition-colors text-sm font-medium">
                Jetzt kaufen
              </button>
            </div>
          </a>
          <a
            href="https://www.docmorris.de"
            target="_blank"
            rel="noopener noreferrer"
            class="p-6 bg-white border-2 border-neutral-200 hover:border-primary rounded-xl transition-all hover:shadow-lg group"
          >
            <div class="flex flex-col items-center text-center">
              <div class="text-4xl font-bold text-neutral-800 mb-3">DocMorris</div>
              <button class="mt-2 px-6 py-2 bg-primary text-white rounded-full group-hover:bg-primary-dark transition-colors text-sm font-medium">
                Jetzt kaufen
              </button>
            </div>
          </a>
        </div>
      </div>

      <!-- Detailed Ingredients Section -->
      {product.ingredients && typeof product.ingredients === 'object' && 'active' in product.ingredients && (
        <section class="my-12">
          <h2 class="text-3xl font-brand font-bold text-neutral-900 mb-6">
            Inhaltsstoffe
          </h2>
          <div class="bg-neutral-50 rounded-xl p-6">
            <div class="mb-6">
              <h3 class="font-semibold text-lg text-neutral-800 mb-3">Wirkstoffe</h3>
              <ul class="space-y-2">
                {product.ingredients.active.map((ingredient: any) => (
                  <li class="flex items-start">
                    <span class="font-medium text-primary mr-2">•</span>
                    <div>
                      <span class="font-medium">{ingredient.name}</span>
                      <p class="text-sm text-neutral-600">{ingredient.description}</p>
                    </div>
                  </li>
                ))}
              </ul>
            </div>

            <div>
              <h3 class="font-semibold text-lg text-neutral-800 mb-3">Weitere Inhaltsstoffe</h3>
              <p class="text-sm text-neutral-600 leading-relaxed">
                {product.ingredients.other}
              </p>
            </div>

            <p class="text-xs text-neutral-500 mt-4">
              Alle Angaben gemäß aktueller Rezeptur. Bei Fragen wenden Sie sich an Ihren Zahnarzt oder Apotheker.
            </p>
          </div>
        </section>
      )}
    </div>
  </section>

  <!-- Scrollytelling Section -->
  <section class="py-24 bg-neutral-900 text-white relative overflow-hidden">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto text-center mb-16">
        <h2 class="text-4xl md:text-5xl font-brand font-bold mb-6">
          {product.howItWorks.title}
        </h2>
        <p class="text-xl text-neutral-300">
          {product.howItWorks.description}
        </p>
      </div>

      <!-- Animation Container -->
      <div class="relative h-[600px] flex items-center justify-center">
        <div id="tooth-animation" class="relative w-full max-w-2xl">
          <div class="relative aspect-square bg-gradient-to-br from-neutral-800 to-neutral-900 rounded-3xl p-12">
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="relative">
                <!-- Tooth Icon -->
                <div class="text-white filter drop-shadow-2xl">
                  <svg class="w-64 h-64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                  </svg>
                </div>

                <!-- Protection Layer Animation -->
                <div class="absolute inset-0 animate-pulse-ring">
                  <div class="absolute inset-0 border-4 border-primary rounded-full opacity-50"></div>
                </div>
              </div>
            </div>

            <!-- Info Labels -->
            {product.howItWorks.steps.map((step, index) => (
              <div
                class={`absolute glass-dark p-4 rounded-xl animate-fade-in ${
                  index === 0 ? 'top-8 left-8' :
                  index === 1 ? 'bottom-8 right-8' :
                  'top-1/2 right-8'
                }`}
                style={`animation-delay: ${index * 0.3}s`}
              >
                <p class="text-sm font-semibold mb-1">Schritt {step.number}</p>
                <p class="text-xs text-neutral-400">{step.title}</p>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Expert Video Section -->
  <section class="py-24 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        <div class="grid md:grid-cols-2 gap-12 items-center">
          <div>
            <h2 class="text-4xl font-brand font-bold text-neutral-900 mb-6">
              {product.usage.title}
            </h2>
            <p class="text-lg text-neutral-600 mb-6">
              {product.usage.expert.description}
            </p>
            <div class="space-y-3">
              {product.usage.instructions.map((instruction) => (
                <div class="flex items-center gap-3">
                  <div class="w-6 h-6 bg-primary/10 rounded-full flex items-center justify-center">
                    <div class="w-2 h-2 bg-primary rounded-full"></div>
                  </div>
                  <span class="text-neutral-700">{instruction}</span>
                </div>
              ))}
            </div>
          </div>

          <div class="relative aspect-video bg-neutral-900 rounded-2xl overflow-hidden shadow-2xl">
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-center">
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 hover:bg-white/30 transition-colors cursor-pointer">
                  <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </div>
                <p class="text-white text-sm">Video abspielen</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- CRAWLER FOCUS MODE -->
<div id="crawler-mode" class="hidden transition-all">
  <div class="min-h-screen bg-gradient-to-br text-gray-500 font-mono p-8">
    <div class="max-w-6xl mx-auto">
      <!-- Terminal Header -->
      <div class="mb-8 pb-4 border-b border-gray-400/30">
        <pre class="text-xs text-gray-500">
elmex.de/produkte/{product.slug}
Last crawled: {new Date().toISOString()}
        </pre>
      </div>

      <!-- Structured Data -->
      <section class="mb-12">
        <h1 class="text-2xl mb-4 text-gray-500">&lt;STRUCTURED DATA&gt;</h1>
        <pre class="bg-neutral-900 p-6 rounded-lg text-xs overflow-x-auto text-gray-500 leading-relaxed border border-gray-400/20">
{JSON.stringify(schemaProduct, null, 2)}
        </pre>
      </section>

      <!-- HTML Structure -->
      <section class="mb-12">
        <h1 class="text-2xl mb-4 text-gray-500">&lt;HTML HIERARCHY&gt;</h1>
        <div class="space-y-2 text-sm">
          <div class="pl-0">&lt;h1&gt; {product.name} &lt;/h1&gt;</div>
          <div class="pl-4">&lt;h2&gt; {product.howItWorks.title} &lt;/h2&gt;</div>
          {product.howItWorks.steps.map((step) => (
            <div class="pl-8">&lt;h3&gt; {step.title} &lt;/h3&gt;</div>
          ))}
          <div class="pl-4">&lt;h2&gt; {product.usage.title} &lt;/h2&gt;</div>
          <div class="pl-4">&lt;h2&gt; Inhaltsstoffe &lt;/h2&gt;</div>
        </div>
      </section>

      <!-- Benefits & Features -->
      <section class="mb-12">
        <h1 class="text-2xl mb-4 text-gray-500">&lt;KEY FEATURES&gt;</h1>
        <div class="space-y-3 text-sm">
          {product.benefits.map((benefit, index) => (
            <div class="p-4 bg-neutral-900 rounded border border-gray-400/20">
              <span class="text-gray-300">[BENEFIT_{index + 1}]</span>
              <p class="text-gray-400/80 mt-2">{benefit}</p>
            </div>
          ))}
        </div>
      </section>

      <!-- Performance Metrics -->
      <section>
        <h1 class="text-2xl mb-4 text-gray-500">&lt;PERFORMANCE METRICS&gt;</h1>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="p-4 bg-neutral-900 rounded border border-gray-400/20">
            <div class="text-xs text-gray-500 mb-1">Load Time</div>
            <div class="text-2xl font-bold">0.3s</div>
          </div>
          <div class="p-4 bg-neutral-900 rounded border border-gray-400/20">
            <div class="text-xs text-gray-500 mb-1">DOM Elements</div>
            <div class="text-2xl font-bold">127</div>
          </div>
          <div class="p-4 bg-neutral-900 rounded border border-gray-400/20">
            <div class="text-xs text-gray-500 mb-1">Page Weight</div>
            <div class="text-2xl font-bold">24KB</div>
          </div>
          <div class="p-4 bg-neutral-900 rounded border border-gray-400/20">
            <div class="text-xs text-gray-500 mb-1">Carbon</div>
            <div class="text-2xl font-bold">0.1g</div>
            <div class="text-xs text-gray-500 mt-1">CO₂</div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Hidden Structured Data for Search Engines -->
<script is:inline type="application/ld+json" set:html={JSON.stringify(schemaProduct)} />

<style>
  @keyframes float {
    0%, 100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-20px);
    }
  }

  @keyframes pulse-ring {
    0%, 100% {
      transform: scale(1);
      opacity: 0.5;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.3;
    }
  }

  .animate-float {
    animation: float 3s ease-in-out infinite;
  }

  .animate-pulse-ring {
    animation: pulse-ring 2s ease-in-out infinite;
  }

  .fluid-blob {
    width: 300px;
    height: 300px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: rgba(255, 96, 0, 0.6);
    border-radius: 50%;
    animation: particle-float 4s ease-in-out infinite;
  }

  .particle-1 {
    top: 20%;
    left: 30%;
    animation-delay: 0s;
  }

  .particle-2 {
    top: 60%;
    right: 20%;
    animation-delay: 1s;
  }

  .particle-3 {
    bottom: 30%;
    left: 25%;
    animation-delay: 2s;
  }

  @keyframes particle-float {
    0%, 100% {
      transform: translate(0, 0);
      opacity: 0;
    }
    50% {
      transform: translate(20px, -40px);
      opacity: 1;
    }
  }

  .glass-dark {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .glass {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
</style>

<script>
  // Vision Switch
  const visionSwitch = document.getElementById('vision-switch') as HTMLInputElement;
  const humanMode = document.getElementById('human-mode');
  const crawlerMode = document.getElementById('crawler-mode');

  visionSwitch?.addEventListener('change', (e) => {
    const target = e.target as HTMLInputElement;
    if (target.checked) {
      // Switch to Crawler mode
      humanMode?.classList.add('hidden');
      crawlerMode?.classList.remove('hidden');

      // Digital glitch effect
      document.body.style.animation = 'glitch 0.3s';
      setTimeout(() => {
        document.body.style.animation = '';
      }, 300);
    } else {
      // Switch to Human mode
      crawlerMode?.classList.add('hidden');
      humanMode?.classList.remove('hidden');
    }
  });

  // Routine Button (No time hints)
  const routineBtn = document.getElementById('routine-btn');
  const routineText = document.getElementById('routine-text');
  let isInRoutine = false;

  routineBtn?.addEventListener('click', () => {
    isInRoutine = !isInRoutine;
    if (isInRoutine) {
      if (routineText) {
        routineText.textContent = '✓ Zur Routine hinzugefügt';
      }
      routineBtn.classList.remove('bg-neutral-100', 'hover:bg-neutral-200', 'text-neutral-700');
      routineBtn.classList.add('bg-green-100', 'hover:bg-green-200', 'text-green-700');
    } else {
      if (routineText) {
        routineText.textContent = 'In Routine aufnehmen';
      }
      routineBtn.classList.remove('bg-green-100', 'hover:bg-green-200', 'text-green-700');
      routineBtn.classList.add('bg-neutral-100', 'hover:bg-neutral-200', 'text-neutral-700');
    }
  });
</script>
