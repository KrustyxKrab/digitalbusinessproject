---
import Layout from "@/layouts/Layout.astro";
import FAQSearch from "@/components/widgets/FAQSearch.astro";
import StructuredData from "@/components/widgets/StructuredData.astro";
import { User, Users } from '@lucide/astro';
import type { ProductDetail } from '@/types/models';
import fs from 'fs';
import path from 'path';

// Load all products dynamically from JSON files
function loadAllProducts(): ProductDetail[] {
  const productsDir = path.join(process.cwd(), 'public', 'products');
  const folders = fs.readdirSync(productsDir);

  return folders
    .filter(folder => {
      const folderPath = path.join(productsDir, folder);
      return fs.statSync(folderPath).isDirectory();
    })
    .map(folder => {
      try {
        const jsonPath = path.join(productsDir, folder, 'product-info.json');
        const json = fs.readFileSync(jsonPath, 'utf-8');
        return JSON.parse(json) as ProductDetail;
      } catch (error) {
        console.error(`Failed to load product: ${folder}`, error);
        return null;
      }
    })
    .filter((p): p is ProductDetail => p !== null);
}

const allProducts = loadAllProducts();

// FAQ Data
const faqs = [
  {
    id: 'faq-1',
    question: 'Was macht Aminfluorid so besonders?',
    answer: 'Aminfluorid bildet eine Schutzschicht auf den Zähnen und ist effektiver als herkömmliches Natriumfluorid. Es remineralisiert den Zahnschmelz und bietet optimalen Schutz vor Karies.',
    category: 'Wissenschaft'
  },
  {
    id: 'faq-2',
    question: 'Ab welchem Alter können Kinder elmex Produkte verwenden?',
    answer: 'elmex bietet speziell entwickelte Produkte für verschiedene Altersgruppen. Ab dem ersten Zahn können Sie elmex Kinderzahnpasta verwenden, und ab 6 Jahren ist die elmex JUNIOR Zahnpasta ideal.',
    category: 'Anwendung'
  },
  {
    id: 'faq-3',
    question: 'Kann ich verschiedene elmex Produkte kombinieren?',
    answer: 'Ja! Alle elmex Produkte sind aufeinander abgestimmt und können optimal kombiniert werden. Für den bestmöglichen Schutz empfehlen wir die Kombination aus Zahnpasta, Mundspülung und der passenden Zahnbürste.',
    category: 'Anwendung'
  },
  {
    id: 'faq-4',
    question: 'Wie oft sollte ich elmex Zahnpasta verwenden?',
    answer: 'Zahnärzte empfehlen, mindestens zweimal täglich die Zähne zu putzen - morgens nach dem Frühstück und abends vor dem Schlafengehen. Jeder Putzvorgang sollte mindestens 2 Minuten dauern.',
    category: 'Anwendung'
  },
  {
    id: 'faq-5',
    question: 'Was ist der Unterschied zwischen elmex KARIESSCHUTZ und elmex SENSITIVE?',
    answer: 'elmex KARIESSCHUTZ ist unser klassisches Produkt für umfassenden Kariesschutz. elmex SENSITIVE wurde speziell für empfindliche Zähne entwickelt und lindert Schmerzempfindlichkeit bei Hitze, Kälte oder Süßem, während es gleichzeitig vor Karies schützt.',
    category: 'Produkte'
  },
  {
    id: 'faq-6',
    question: 'Sind elmex Produkte für Schwangere geeignet?',
    answer: 'Ja, elmex Produkte sind für Schwangere sicher und empfohlen. Gerade während der Schwangerschaft ist gute Mundhygiene besonders wichtig. Bei spezifischen Fragen konsultieren Sie bitte Ihren Zahnarzt.',
    category: 'Anwendung'
  },
  {
    id: 'faq-7',
    question: 'Warum ist Fluorid wichtig für die Zahngesundheit?',
    answer: 'Fluorid stärkt den Zahnschmelz und macht ihn widerstandsfähiger gegen Säureangriffe. Es fördert die Remineralisierung und hilft, beginnende Kariesläsionen zu reparieren. Aminfluorid, wie es in elmex verwendet wird, ist besonders effektiv.',
    category: 'Wissenschaft'
  },
  {
    id: 'faq-8',
    question: 'Wo kann ich elmex Produkte kaufen?',
    answer: 'elmex Produkte sind in Apotheken, Drogeriemärkten (dm, Rossmann, Müller) und online erhältlich. Nutzen Sie unseren <a href="/beratung/wo-kaufen" class="text-primary hover:underline">Händler-Finder</a> für Geschäfte in Ihrer Nähe.',
    category: 'Produkte'
  },
  {
    id: 'faq-9',
    question: 'Ist elmex vegan?',
    answer: 'Die meisten elmex Zahnpasten sind vegan. Detaillierte Informationen zu Inhaltsstoffen finden Sie auf der jeweiligen Produktverpackung oder auf den einzelnen Produktseiten.',
    category: 'Produkte'
  },
  {
    id: 'faq-10',
    question: 'Wie lagere ich elmex Zahnpasta richtig?',
    answer: 'Bewahren Sie elmex Zahnpasta bei Raumtemperatur auf, geschützt vor direkter Sonneneinstrahlung. Verschließen Sie die Tube nach jedem Gebrauch, um die Qualität zu erhalten.',
    category: 'Anwendung'
  }
];
---

<Layout
  title="Produkte | elmex"
  description="Entdecken Sie die komplette Produktpalette von elmex - Zahnpasta, Mundspülung und Zahnbürsten mit wissenschaftlich fundiertem Kariesschutz."
  keywords="elmex Produkte, Zahnpasta, Mundspülung, Zahnbürste, Kariesschutz, Aminfluorid"
>
  <!-- FAQPage Schema for AI/GEO -->
  <StructuredData type="faq" data={faqs} slot="head" />
  <!-- Hero Section -->
  <section class="relative site-container mx-auto mt-12 md:mt-20 px-4">
    <div class="max-w-4xl mx-auto text-center">
      <h1 class="text-4xl md:text-5xl lg:text-6xl font-brand font-bold text-neutral-900 mb-6">
        Unsere Produkte
      </h1>
      <p class="text-lg md:text-xl text-neutral-700 mb-8">
        Wissenschaftlich fundierte Zahnpflege für jedes Bedürfnis
      </p>

      <!-- AI-Optimized Quick Facts (hidden from users, optimized for crawlers) -->
      <div class="sr-only" role="complementary" aria-label="Produktübersicht für Suchmaschinen">
        <h2>elmex Produktübersicht - Schnellfakten</h2>
        <dl>
          <dt>Produktkategorien:</dt>
          <dd>Zahnpasta (Kariesschutz, Zahnfleisch, Sensitive, Junior), Mundspülung (Karies, Sensitive), Zahnbürsten (InterX, Sensitive)</dd>
          <dt>Hauptwirkstoff:</dt>
          <dd>Aminfluorid (Olafluor) - Klinisch getestet in über 500 Studien</dd>
          <dt>Zielgruppen:</dt>
          <dd>Kinder ab dem ersten Zahn, Jugendliche, Erwachsene, Senioren, Menschen mit empfindlichen Zähnen</dd>
          <dt>Hauptvorteile:</dt>
          <dd>Kariesprävention, Zahnschmelz-Remineralisierung, Zahnfleischpflege, Schmerzlinderung bei Empfindlichkeit</dd>
          <dt>Verfügbarkeit:</dt>
          <dd>Deutschland - Apotheken, Drogeriemärkte (dm, Rossmann, Müller), Online-Shops (Amazon, DocMorris)</dd>
          <dt>Herstellung:</dt>
          <dd>Made in Germany seit 1962, Colgate-Palmolive</dd>
        </dl>
      </div>
    </div>
  </section>

  <!-- Personalized "Für Ihre Routine" Section -->
  <section id="personalized-section" class="hidden container mx-auto px-4 mt-12">
    <div class="bg-neutral-50 rounded-2xl p-8">
      <div class="mb-6">
        <h2 id="personalized-title" class="text-2xl md:text-3xl font-brand font-bold text-neutral-900 mb-2">
          Für Ihre Routine
        </h2>
        <p id="personalized-subtitle" class="text-neutral-600">
          Basierend auf Ihren Antworten
        </p>
      </div>
      <div id="personalized-products" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Dynamically populated -->
      </div>
    </div>
  </section>

  <!-- Filter & Sort Section -->
  <section class="container mx-auto px-4 mt-12">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <!-- Category Filter -->
      <div class="flex flex-wrap gap-2">
        <button class="category-filter active px-4 py-2 rounded-full text-sm font-medium bg-primary text-white transition-all">
          Alle
        </button>
        <button class="category-filter px-4 py-2 rounded-full text-sm font-medium bg-neutral-200 text-neutral-700 hover:bg-primary hover:text-white transition-all">
          Zahnpasta
        </button>
        <button class="category-filter px-4 py-2 rounded-full text-sm font-medium bg-neutral-200 text-neutral-700 hover:bg-primary hover:text-white transition-all">
          Mundspülung
        </button>
        <button class="category-filter px-4 py-2 rounded-full text-sm font-medium bg-neutral-200 text-neutral-700 hover:bg-primary hover:text-white transition-all">
          Zahnbürste
        </button>
      </div>

      <!-- Sort Options -->
      <div class="flex items-center gap-2">
        <label for="sort" class="text-sm text-neutral-600">Sortieren:</label>
        <select id="sort" class="px-4 py-2 rounded-lg bg-white border border-neutral-300 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="popular">Beliebt</option>
          <option value="new">Neu</option>
          <option value="a-z">A-Z</option>
          <option value="z-a">Z-A</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Products Grid -->
  <section class="container mx-auto px-4 mb-16">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      {allProducts.map(product => {
        // Determine category for filtering
        let categoryClass = 'zahnpasta';
        if (product.category === 'mouthwash') categoryClass = 'mundspuelung';
        else if (product.category === 'toothbrush') categoryClass = 'zahnbuerste';

        // Get first two benefits as tags if available, otherwise use generic ones
        const tags = product.benefits?.slice(0, 2) || [product.productLine, 'Klinisch geprüft'];

        return (
          <a
            href={`/produkte/${product.slug}`}
            class="product-card block bg-white rounded-2xl p-6 shadow-lg hover:shadow-2xl transition-all cursor-pointer hover:scale-105 transform duration-300"
            data-category={categoryClass}
          >
            <div class="relative w-full h-48 rounded-xl overflow-hidden mb-4">
              <img
                src={`/products/${product.slug}/${product.slug}_01.png`}
                alt={product.name}
                class="product-img-main absolute inset-0 w-full h-full object-contain transition-opacity duration-300"
              />
              <img
                src={`/products/${product.slug}/${product.slug}_02.png`}
                alt={`${product.name} - Ansicht 2`}
                class="product-img-hover absolute inset-0 w-full h-full object-contain opacity-0 transition-opacity duration-300"
              />
            </div>
            <h3 class="text-lg font-brand font-semibold text-neutral-900 mb-2">
              {product.name}
            </h3>
            <p class="text-sm text-neutral-600 mb-4">
              {product.description}
            </p>
            <div class="flex flex-wrap gap-2 mb-4">
              {tags.map(tag => (
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">{tag}</span>
              ))}
            </div>
            <div class="flex flex-col gap-2">
              <button
                onclick={`event.preventDefault(); event.stopPropagation(); window.location.href='/beratung/wo-kaufen?product=${encodeURIComponent(product.name)}'`}
                class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-full text-sm font-medium transition-colors"
              >
                Wo kaufen
              </button>
            </div>
          </a>
        );
      })}
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="container mx-auto px-4 mb-16">
    <div class="max-w-3xl mx-auto">
      <h2 class="text-3xl md:text-4xl font-brand font-bold text-neutral-900 mb-8 text-center">
        Häufig gestellte Fragen
      </h2>
      <FAQSearch faqs={faqs} />
    </div>
  </section>

  <!-- CTA Section with Inline Product Finder -->
  <section class="container mx-auto px-4 mb-16">
    <div class="bg-gradient-to-br from-primary to-red-500 rounded-2xl p-8 md:p-12 text-white">
      <div class="max-w-3xl mx-auto">
        <div class="text-center mb-8">
          <h2 class="text-3xl md:text-4xl font-brand font-bold mb-4">
            Nicht sicher, welches Produkt passt?
          </h2>
          <p class="text-lg opacity-90">
            Unser Produktfinder hilft Ihnen in 5 Fragen zur perfekten Empfehlung
          </p>
        </div>

        <!-- Inline mini finder (Question 1 only) -->
        <div class="bg-white rounded-xl p-6 text-neutral-900">
          <h3 class="text-xl font-semibold mb-4">Für wen suchen Sie?</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <a href="/beratung/produktfinder?intent=self" class="flex items-center gap-3 p-4 bg-neutral-50 hover:bg-neutral-100 rounded-lg transition-colors">
              <User class="w-8 h-8 text-primary flex-shrink-0" />
              <span class="font-medium">Für mich selbst</span>
            </a>
            <a href="/beratung/produktfinder?intent=other" class="flex items-center gap-3 p-4 bg-neutral-50 hover:bg-neutral-100 rounded-lg transition-colors">
              <Users class="w-8 h-8 text-primary flex-shrink-0" />
              <span class="font-medium">Für andere</span>
            </a>
          </div>
        </div>

        <div class="text-center mt-6">
          <a href="/beratung/produktfinder" class="text-white/80 hover:text-white underline text-sm">
            Oder starten Sie den vollständigen Produktfinder →
          </a>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  // Load personalized recommendations
  function loadPersonalizedSection() {
    const section = document.getElementById('personalized-section');
    const title = document.getElementById('personalized-title');
    const subtitle = document.getElementById('personalized-subtitle');
    const container = document.getElementById('personalized-products');

    if (!section || !title || !subtitle || !container) return;

    // Get user profile from localStorage
    const userProfileStr = localStorage.getItem('elmex-user-profile');
    let recommendations: any[] = [];

    if (userProfileStr) {
      try {
        const userProfile = JSON.parse(userProfileStr);
        const concern = userProfile.concern;
        const ageGroup = userProfile.ageGroup;

        // Build product lookup from DOM - all products already rendered
        const allProductCards = Array.from(document.querySelectorAll('.product-card[data-category]'));
        const productsBySlug = new Map();

        allProductCards.forEach(card => {
          const href = card.getAttribute('href') || '';
          const slug = href.split('/').pop() || '';
          const name = card.querySelector('h3')?.textContent?.trim() || '';
          const description = card.querySelector('p')?.textContent?.trim() || '';
          const image = card.querySelector('.product-img-main')?.getAttribute('src') || '';
          const image2 = card.querySelector('.product-img-hover')?.getAttribute('src') || '';
          const tags = Array.from(card.querySelectorAll('span')).map(s => s.textContent?.trim() || '');

          productsBySlug.set(slug, {
            name,
            description,
            url: href,
            slug,
            image,
            image2,
            tags
          });
        });

        // Personalization logic based on quiz data
        if (concern === 'sensitivity') {
          const sensitive = productsBySlug.get('sensitive-zahnpasta');
          const sensitivePro = productsBySlug.get('elmexsensitiveprofessional');
          if (sensitive) recommendations.push(sensitive);
          if (sensitivePro) recommendations.push(sensitivePro);
          title.textContent = 'Für Ihre Routine';
          subtitle.textContent = 'Basierend auf Ihren Antworten - Empfindliche Zähne';
        } else if (concern === 'cavity') {
          const kariesschutz = productsBySlug.get('kariesschutz-zahnpasta');
          const zahnfleisch = productsBySlug.get('elmexprotectionprofessional');
          if (kariesschutz) recommendations.push(kariesschutz);
          if (zahnfleisch) recommendations.push(zahnfleisch);
          title.textContent = 'Für Ihre Routine';
          subtitle.textContent = 'Basierend auf Ihren Antworten - Kariesschutz';
        } else if (concern === 'gum') {
          const zahnfleisch = productsBySlug.get('elmexprotectionprofessional');
          const kariesschutz = productsBySlug.get('kariesschutz-zahnpasta');
          if (zahnfleisch) recommendations.push(zahnfleisch);
          if (kariesschutz) recommendations.push(kariesschutz);
          title.textContent = 'Für Ihre Routine';
          subtitle.textContent = 'Basierend auf Ihren Antworten - Zahnfleischpflege';
        } else if (concern === 'whitening') {
          const white = productsBySlug.get('elmexwhite');
          const kariesschutz = productsBySlug.get('kariesschutz-zahnpasta');
          if (white) recommendations.push(white);
          if (kariesschutz) recommendations.push(kariesschutz);
          title.textContent = 'Für Ihre Routine';
          subtitle.textContent = 'Basierend auf Ihren Antworten - Weißere Zähne';
        }

        // Add junior products for young age groups
        if (ageGroup === 'junior' || ageGroup === 'baby') {
          const junior = productsBySlug.get('elmexjunior');
          if (junior) recommendations = [junior];
          title.textContent = 'Für Ihre Routine';
          subtitle.textContent = 'Basierend auf Ihren Antworten - Kinderzahnpflege';
        }
      } catch (e) {
        console.error('Error parsing user profile:', e);
      }
    }

    // Fallback to default recommendations if no personalization
    if (recommendations.length === 0) {
      // Don't show the personalized section if no recommendations
      return;
    }

    // Limit to 3-4 products
    recommendations = recommendations.slice(0, 4);

    // Render product cards
    container.innerHTML = recommendations.map(product => `
      <a href="${product.url}" class="product-card block bg-white rounded-2xl p-6 shadow-lg hover:shadow-2xl transition-all cursor-pointer hover:scale-105 transform duration-300">
        <div class="relative w-full h-48 rounded-xl overflow-hidden mb-4">
          <img
            src="${product.image}"
            alt="${product.name}"
            class="product-img-main absolute inset-0 w-full h-full object-contain transition-opacity duration-300"
          />
          <img
            src="${product.image2}"
            alt="${product.name} - Ansicht 2"
            class="product-img-hover absolute inset-0 w-full h-full object-contain opacity-0 transition-opacity duration-300"
          />
        </div>
        <h3 class="text-lg font-brand font-semibold text-neutral-900 mb-2">
          ${product.name}
        </h3>
        <p class="text-sm text-neutral-600 mb-4">
          ${product.description}
        </p>
        <div class="flex flex-wrap gap-2 mb-4">
          ${product.tags.map((tag: string) => `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${tag}</span>`).join('')}
        </div>
      </a>
    `).join('');

    // Show the section
    section.classList.remove('hidden');
  }

  // Category filtering
  const categoryFilters = document.querySelectorAll('.category-filter');
  const productCards = document.querySelectorAll('.product-card');

  categoryFilters.forEach(filter => {
    filter.addEventListener('click', () => {
      // Update active state
      categoryFilters.forEach(f => {
        f.classList.remove('active', 'bg-primary', 'text-white');
        f.classList.add('bg-neutral-200', 'text-neutral-700');
      });
      filter.classList.add('active', 'bg-primary', 'text-white');
      filter.classList.remove('bg-neutral-200', 'text-neutral-700');

      // Filter products
      const category = filter.textContent?.trim().toLowerCase();
      productCards.forEach(card => {
        const htmlCard = card as HTMLElement;
        if (category === 'alle' || card.getAttribute('data-category') === category) {
          htmlCard.style.display = 'block';
        } else {
          htmlCard.style.display = 'none';
        }
      });
    });
  });

  // Sort functionality (placeholder - would need actual implementation)
  const sortSelect = document.getElementById('sort') as HTMLSelectElement;
  sortSelect?.addEventListener('change', (e) => {
    const sortValue = (e.target as HTMLSelectElement).value;
    console.log('Sorting by:', sortValue);
    // Implement sorting logic here
  });

  // Initialize personalized section on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadPersonalizedSection();
  });
</script>

<style>
  /* Hover effect for image swap */
  .product-card:hover .product-img-main {
    opacity: 0;
  }
  .product-card:hover .product-img-hover {
    opacity: 1;
  }
</style>
